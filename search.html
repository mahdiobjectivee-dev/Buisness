<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Rongtuli — Smart AI Search</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* ---------- Your original styles (unchanged) + animation additions ---------- */
    body {
      font-family: "Inter", system-ui, Arial;
      background: #f6f8fb;
      color: #143047;
      margin: 0;
      padding: 18px;
    }
    .wrap {
      max-width: 1100px;
      margin: 0 auto;
    }
  .search-bar {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-bottom: 12px;
  position: relative;
  background: #ffffff; /* slightly contrasting background */
  padding: 8px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(16,24,40,0.06);
  transition: box-shadow 0.2s ease;
}

.search-bar:hover {
  box-shadow: 0 6px 18px rgba(16,24,40,0.1);
}

.search-bar input {
  flex: 1;
  padding: 14px 16px;
  border-radius: 12px;
  border: 1px solid #e6eef7;
  font-size: 16px;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.search-bar input:focus {
  outline: none;
  border-color: #6aa8d6;
  box-shadow: 0 4px 12px rgba(106,168,214,0.25);
}

.search-bar button {
  padding: 10px 16px;
  border-radius: 12px;
  border: 0;
  background: #6aa8d6;
  color: white;
  font-weight: 700;
  cursor: pointer;
  transition: background 0.2s ease, transform 0.2s ease;
}

.search-bar button:hover {
  background: #5a92c0;
  transform: scale(1.05);
}

.search-bar .clear {
  background: #fff;
  border: 1px solid #e6eef7;
  color: #7092b0;
  font-weight: 600;
  transition: background 0.2s ease, color 0.2s ease, transform 0.2s ease;
}

.search-bar .clear:hover {
  background: #f1f8ff;
  border-color: #7092b0;
  color: #7092b0;
  transform: scale(1.05);
}

@media (max-width: 420px) {
  .search-bar {
    flex-wrap: wrap;      /* allow elements to stack */
    gap: 8px;
    padding: 8px;
  }

  /* input becomes full-width row 1 */
  .search-bar input {
    order: 1;
    flex: 1 1 100%;
    width: 100%;
    height: 46px;
    padding: 12px 14px;
    border-radius: 12px;
  }

  /* buttons move below input and stretch full width for easy tapping */
  .search-bar button {
    order: 2;
    width: 100%;
    min-width: 0;
    flex: 1 1 100%;
    text-align: center;
    border-radius: 10px;
    height: 44px;
  }

  /* keep clear separate if present */
  .search-bar .clear { order: 3; width: 100%; height: 40px; }

  /* suggestions should not overflow off-screen on tiny devices */
  .suggestions { max-width: 100vw; left: 0; right: 0; }
}

/* --- Slight tweak for medium phones to ensure exactly 2-up layout (if used together with results grid) --- */
@media (max-width: 720px) {
  .search-bar input { font-size: 15px; padding: 11px 12px; }
  .search-bar button { min-width: 64px; padding: 9px 10px; font-size: 15px; }
}

/* Accessibility: visible focus for keyboard/touch users */
.search-bar input:focus,
.search-bar button:focus,
.search-bar .clear:focus {
  outline: 3px solid rgba(106,168,214,0.18);
  outline-offset: 2px;
}

/* Prevent accidental horizontal scrolling caused by long placeholder text */
.search-bar input::placeholder { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* optional: collapse long button text on very small screens and keep label readable (uncomment if desired)
@media (max-width: 360px) {
  .search-bar button { font-size: 14px; padding: 10px 8px; }
}
  
*/

.wrap > a:first-of-type {
  margin-top: 24px;
  display: inline-block;
}


    /* Suggestions dropdown */
    .suggestions {
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      right: 0;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 8px 30px rgba(16,24,40,0.08);
      max-height: 260px;
      overflow:auto;
      z-index: 999;
      border: 1px solid #eef4fb;

      opacity: 0;
      transform: translateY(6px);
      transition: opacity 420ms cubic-bezier(.2,.9,.2,1), transform 420ms cubic-bezier(.2,.9,.2,1);
      will-change: transform, opacity;
    }
    .suggestions.in { opacity: 1; transform: translateY(0); }

    .suggestion-item {
      padding: 10px 12px;
      cursor: pointer;
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:center;
      font-weight:600;

      opacity: 0;
      transform: translateY(6px);
      transition: opacity 420ms cubic-bezier(.2,.9,.2,1), transform 420ms cubic-bezier(.2,.9,.2,1);
    }
    .suggestion-item.visible { opacity: 1; transform: translateY(0); }

    .suggestion-item:hover, .suggestion-item.active { background:#f1f8ff; }

    .results {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 12px;

      opacity: 0;
      transform: translateY(8px);
      transition: opacity 620ms cubic-bezier(.2,.9,.2,1), transform 620ms cubic-bezier(.2,.9,.2,1);
    }
    .results.in { opacity: 1; transform: translateY(0); }

    .product-card {
      width: 220px;
      background: #fff;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 8px 26px rgba(16,24,40,0.06);
      display: flex;
      flex-direction: column;
      gap: 8px;
      cursor: pointer;

      opacity: 0;
      transform: translateY(12px) scale(.995);
      transition: transform 620ms cubic-bezier(.2,.9,.2,1), opacity 620ms cubic-bezier(.2,.9,.2,1);
      will-change: transform, opacity;
    }
    .product-card.in { opacity: 1; transform: translateY(0) scale(1); }
    .product-card.out { opacity: 0; transform: translateY(-8px) scale(.99); transition: transform 260ms linear, opacity 260ms linear; }

    .product-thumb {
      height: 140px;
      border-radius: 8px;
      overflow: hidden;
      background: #f6f8fb;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .product-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display:block;
      opacity: 0;
      transform: translateY(6px) scale(.998);
      transition: opacity 620ms cubic-bezier(.2,.9,.2,1), transform 620ms cubic-bezier(.2,.9,.2,1);
    }
    .product-thumb img.in { opacity:1; transform: translateY(0) scale(1); }
    .product-name {
      font-weight: 800;
      color: #7092b0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .product-price {
      font-weight: 800;
      color: #143047a9;
    }
    .add-btn {
      background: #6aa8d6;
      color: white;
      border: 0;
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 800;
    }
    .meta {
      font-size: 13px;
      color: #6b7280;
    }
    .small {
      font-size: 13px;
      color: #6b7280;
      margin-top: 8px;
    }

    /* "no results" + suggested alternatives box */
    .no-results {
      background: #fff;
      padding: 14px;
      border-radius: 12px;
      box-shadow: 0 8px 26px rgba(16,24,40,0.06);
      color: #6b7280;
      width:100%;

      opacity: 0;
      transform: translateY(8px);
      transition: opacity 420ms cubic-bezier(.2,.9,.2,1), transform 420ms cubic-bezier(.2,.9,.2,1);
    }
    .no-results.in { opacity: 1; transform: translateY(0); }

    @media (max-width:720px){
      .product-card { width: calc(50% - 12px); }
    }
    @media (max-width:420px){
      .product-card { width: 100%; }

    }


    .header {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 1rem 0;
  }

      .logo { height: 90px; max-width: 100%; }

 /* Keep desktop look even on mobile */
.navbar {
  background-color: #dce4cc;
  display: flex;
  justify-content: center;
  align-items: center;
  flex-wrap: nowrap; /* stop breaking into multiple lines */
  gap: 1.5rem;
  padding: 0.7rem 1rem;
  border-radius: 13px;
  margin: 0 auto;
  width: fit-content;
  overflow-x: auto; /* allow horizontal scroll if needed */
  scrollbar-width: none; /* hide scrollbar (Firefox) */
  -ms-overflow-style: none; /* hide scrollbar (IE/Edge) */
}
.navbar::-webkit-scrollbar { display: none; } /* hide scrollbar (Chrome/Safari) */

.navbar a {
  text-decoration: none;
  font-weight: 600;
  color: #415a4a;
  font-size: 1rem;
  transition: color 0.2s ease;
  opacity: 0;
  transform: translateY(6px);
}
.navbar.ready a { animation: navIn 620ms cubic-bezier(.2,.9,.2,1) forwards; }
.navbar.ready a:nth-child(1){ animation-delay: 80ms; }
.navbar.ready a:nth-child(2){ animation-delay: 160ms; }
.navbar.ready a:nth-child(3){ animation-delay: 240ms; }
@keyframes navIn { to { opacity: 1; transform: translateY(0); } }

/* Cart styles (kept intact) + anim classes */
:root{
  --cart-width:340px;
  --accent:#6aa8d6;
  --accent-dark:#6aa8d6;
  --muted:#7b8794;
  --text:#7092b0;
  --toggle-width: 92px;
  --cart-offset-desktop: 60px;
  --cart-offset-mobile-right: 12px;
}
#cart-toggle {
  position: fixed;
  right: var(--cart-offset-desktop);
  top: 22px;
  background: var(--accent);
  color: #fff;
  padding: 10px 14px;
  border-radius: 12px;
  font-weight: 600;
  font-size: 14px;
  box-shadow: 0 4px 14px rgba(0,0,0,0.12);
  cursor: pointer;
  z-index: 12000;
  display: flex;
  align-items: center;
  gap: 6px;
  border: none;
  transition: all 0.18s ease;
}
#cart-toggle:hover { background: var(--accent-dark); transform: translateY(-2px); }
#cart-toggle .count { background: #fff; color: var(--accent-dark); padding: 2px 8px; border-radius: 999px; font-weight: 700; font-size: 12px; }

/* cart panel (block layout) */
#cart {
  position: fixed;
  right: var(--cart-offset-desktop);
  top: 70px;
  width: var(--cart-width);
  max-width: calc(100% - 40px);
  max-height: calc(100vh - 96px);
  overflow-y: auto;
  overflow-x: hidden;
  background: #fff;
  border-radius: 14px;
  padding: 18px;
  box-shadow: 0 12px 40px rgba(0,0,0,0.12);
  z-index: 11000;
  transition: transform 0.22s ease, opacity 0.22s ease;
  display: block;
  -webkit-overflow-scrolling: touch;
  opacity: 1;
  transform: translateY(0) scale(1);
}
#cart.hidden { transform: translateY(-10px) scale(0.98); opacity: 0; pointer-events: none; display: none; }

#cart.anim-in { transform: translateY(0) scale(1); opacity: 1; transition: transform 260ms cubic-bezier(.2,.9,.2,1), opacity 260ms cubic-bezier(.2,.9,.2,1); }
#cart.anim-out { transform: translateY(-8px) scale(.99); opacity: 0; transition: transform 260ms cubic-bezier(.2,.9,.2,1), opacity 260ms cubic-bezier(.2,.9,.2,1); }

#cart h2 { margin: 0 0 12px 0; font-size: 18px; color: #143047; }
#cart p { margin: 8px 0; font-weight: 700; color: #143047; }

#cart-rows > .cart-row {
  display: flex;
  gap: 12px;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid rgba(0,0,0,0.06);
  margin-bottom: 6px;
  flex-wrap: wrap;
  min-height: 56px;
}
#cart-rows > .cart-row:last-child { border-bottom: none; margin-bottom: 0; }

#cart .cart-img { width: 56px; height: 56px; object-fit: cover; border-radius: 8px; flex: 0 0 56px; background: #f2f4f6; }

#cart .cart-text { flex: 1 1 auto; min-width: 0; }
#cart .cart-text > div:first-child { font-weight: 800; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #143047; }
#cart .cart-text > div:last-child { font-size: 13px; color: var(--muted); margin-top: 4px; }

#cart .cart-controls { display: flex; flex-direction: column; gap: 6px; align-items: flex-end; flex: 0 0 auto; margin-left: 8px; }

.small-btn { background: transparent; border: 1px solid rgba(16,24,40,0.06); padding: 6px 8px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 13px; }
.small-btn.icon { min-width:36px; padding:6px 10px; text-align:center; }
.small-btn:active { transform: translateY(1px); }

.cart-footer { margin-top: 12px; display: flex; gap: 8px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
.cart-footer .checkout-wrap { flex: 1 1 100%; }
#checkout-btn { background: linear-gradient(180deg,var(--accent),var(--accent-dark)); color: white; border: none; padding: 12px 14px; border-radius: 10px; cursor: pointer; font-weight: 800; width: 70%; box-shadow: 0 8px 18px rgba(106,168,214,0.16); }
#cart-close-footer { background: transparent; border: 1px solid rgba(16,24,40,0.08);  padding: 12px 14px;  border-radius: 10px; cursor: pointer; font-weight: 700; color: #143047; white-space: nowrap; }
  footer{max-width:1000px;margin:28px auto;text-align:center;color:var(--muted)}

#subtotal, #shipping, #total { margin: 8px 0; font-weight: 600; color: var(--muted); font-size: 14px; }
#total { color: #143047; font-size: 16px; }

@media (max-width: 900px) {
  .product-card { width: calc(50% - 12px); }
  #cart {
    right: 12px;
    width: calc(100% - 24px);
    top: auto;
    bottom: 90px;
  }
  #cart-toggle {
    top: auto;
    bottom: 22px;
    right: var(--cart-offset-mobile-right);
    padding: 12px 16px;
    z-index: 13000;
    width: var(--toggle-width);
    justify-content: center;
  }
  #checkout-btn { width: 100%; }
  #cart-close-footer { width: 100%; }
}
@media (max-width: 420px) { .product-card { width: 100%; } }

/* small cart badge bump */
#cart-toggle.bump { animation: cartBump 700ms cubic-bezier(.2,.9,.2,1); }
@keyframes cartBump {
  0% { transform: scale(1); }
  25% { transform: scale(1.18) translateY(-3px); }
  60% { transform: scale(.96) translateY(0); }
  100% { transform: scale(1); }
}

/* shimmer while images load */
.product-thumb img[data-loading="true"] {
  opacity: 0.5;
  transition: opacity 0.5s ease;
}

/* page-level exit */
.page-exit .wrap,
.page-exit .navbar,
.page-exit .header,
.page-exit .ai-promo,
.page-exit #results {
  opacity: 0;
  transform: translateY(-8px) scale(.997);
  transition: opacity 260ms cubic-bezier(.2,.9,.2,1), transform 260ms cubic-bezier(.2,.9,.2,1);
}

/* Respect reduced motion */
@media (prefers-reduced-motion: reduce) {
  * { animation: none !important; transition: none !important; }
  .suggestions, .results, .product-card, .product-thumb img, .no-results { opacity: 1 !important; transform: none !important; }
  .navbar a { opacity: 1 !important; transform: none !important; }
}

/* fixed product image size — paste at END of <style> */
:root { --product-img-size: 140px; }

*,
*::before,
*::after { box-sizing: border-box; }

.product-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  width: 220px;       /* keeps desktop card width unchanged */
  padding: 12px;
  min-width: 0;
  box-sizing: border-box;
}

/* fixed square container */
.product-thumb {
  width: var(--product-img-size);
  height: var(--product-img-size);
  border-radius: 8px;
  overflow: hidden;
  background: #f6f8fb;
  display:flex;
  align-items:center;
  justify-content:center;
  flex: 0 0 var(--product-img-size);
  margin: 0 auto;
  position: relative;
}

/* make image always cover the square without stretching */
.product-thumb img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

/* keep text centered under the image */
.product-name, .product-price, .meta, .small {
  width: 100%;
  text-align: center;
  min-width: 0;
}

/* responsive: ensure two-column grid on phones while preventing overflow */
@media (max-width: 720px) {
  .results {
    display: grid !important;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }
  .product-card {
    width: 100%;
    min-width: calc(var(--product-img-size) + 24px);
    padding-top: 12px;
    padding-bottom: 12px;
    align-items: center;
  }
}

/* tiny phones: reduce image slightly to avoid horizontal scrolling */
@media (max-width: 360px) {
  :root { --product-img-size: 120px; } /* optional — remove this block if you want the image never to change */
  .results { grid-template-columns: 1fr; }
  .product-card { padding-left: 10px; padding-right: 10px; }
}

/* defensive */
html, body { overflow-x: hidden; }

  </style>
</head>
<body>
      <header class="header">
<a href="index.html">
  <img src="assets/logo.png" alt="Rongtuli Logo" class="logo" />
</a>  </header>

  <nav class="navbar">
    <a href="#">Sarees</a>
    <a href="#">Creams</a>
    <a href="#">Hair Bands</a>
    
  </nav>

  <div class="wrap">
    <a href="#" 
   style="text-decoration:none;color:var(--muted)" 
   onclick="(function(e){
     e.preventDefault();
     try {
       // if there's a previous page in history -> go back
       if (history.length > 1) {
         history.back();
       } else {
         // fallback if opened directly / no history
         window.location.href = 'index.html';
       }
     } catch(err) {
       // fallback on error
       window.location.href = 'index.html';
     }
   })(event);">
  ← Go Back
</a>
<h2 style="color: #7092b0;">Smart AI Search</h2>

    <div class="search-bar">
      <input id="aiQuery" placeholder="Type something like 'Dreses, Wears'..." autocomplete="off" aria-autocomplete="list" />
      <button id="searchBtn">Search</button>
      <button id="clearBtn" class="clear">Clear</button>

      <!-- suggestions dropdown -->
      <div id="suggestions" class="suggestions" style="display:none"></div>
    </div>

    <div id="status" class="small">Loading products...</div>
    <div id="results" class="results" style="margin-top:12px"></div>
  </div>

  <!-- ---------- Cart UI inserted (copied) ---------- -->
  <button id="cart-toggle" aria-expanded="false" title="Open cart">Cart <span class="count">0</span></button>

  <div id="cart" class="hidden" aria-hidden="true">
    <h2>Your Cart</h2>

    <div id="cart-rows">Cart is empty.</div>

    <div class="cart-footer">
      <div class="checkout-wrap">
        <p id="subtotal">Subtotal: QAR 0.00</p>
        <p id="shipping">Shipping: QAR 0.00</p>
        <p id="total">Total: QAR 0.00</p>
        <button id="checkout-btn">Checkout via WhatsApp</button>
           <button id="cart-close-footer" type="button">Close</button>
 </div>
    </div>
  </div>
  <!-- ---------- end cart UI ---------- -->

<div><footer id="foot">© <span id="year"></span> Rongtuli</footer></div>

  <!-- Scripts -->
 <script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  // Use a reliable Fuse CDN
  const FUSE_URL = 'https://unpkg.com/fuse.js@6.6.2/dist/fuse.min.js';

  const SUPABASE_URL = 'https://qhslurjvanppitwuuxtv.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFoc2x1cmp2YW5wcGl0d3V1eHR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NTg0MjEsImV4cCI6MjA3NjUzNDQyMX0.8PNOewgJFDGVVIDdiEbdFE2x9Yzv29o2kdAANqaW1gA';

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // global-ish
  let products = [];
  let fuse = null;

  // DOM refs (guarded)
  const resultsEl = document.getElementById('results');
  const statusEl = document.getElementById('status');
  const searchInput = document.getElementById('aiQuery');
  const suggestionsEl = document.getElementById('suggestions');
  document.getElementById('year') && (document.getElementById('year').textContent = new Date().getFullYear());

  // small debounce helper
  function debounce(fn, wait = 250) {
    let t;
    return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
  }

  async function loadFuse() {
    if (window.Fuse) return;
    await new Promise((resolve, reject) => {
      const s = document.createElement('script');
      s.src = FUSE_URL;
      s.onload = resolve;
      s.onerror = () => reject(new Error('Failed to load Fuse.js from CDN'));
      document.head.appendChild(s);
    });
  }

  /* -------------------------
     CURRENCY HELPERS
     - Uses localStorage.site_currency (default 'QAR')
     - formatPriceWithLabel(amount) -> "QAR 10.00" or "BDT 10.00"
     ------------------------- */
  const CURRENCY_KEY = 'site_currency';
  function getSelectedCurrency(){ return (localStorage.getItem(CURRENCY_KEY) || 'QAR').toUpperCase(); }
  function setSelectedCurrency(v){ localStorage.setItem(CURRENCY_KEY, (v||'QAR').toUpperCase()); }
  function formatPriceWithLabel(amount){
    const cur = getSelectedCurrency();
    const n = Number(amount) || 0;
    return (cur === 'BDT' ? 'BDT ' : 'QAR ') + n.toFixed(2);
  }
  // backwards-compat alias
  function formatPrice(n){ return formatPriceWithLabel(n); }

  // escape helper
  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"'`=\/]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#x60;','/':'&#x2F;'}[c])); }

  /* -------------------------
     Load products from Supabase (now fetches price_qar & price_bdt)
     - Builds local `products` array used by Fuse and rendering
     ------------------------- */
  async function loadProducts() {
    if (statusEl) statusEl.textContent = 'Loading products ...';
    try {
      const { data, error } = await supabase
        .from('products')
        .select('id, name, description, category, price, price_qar, price_bdt, sku, image_urls')
        .order('created_at', { ascending: false });

      if (error) {
        console.error(error);
        if (statusEl) statusEl.textContent = 'Error loading products.';
        products = [];
        return;
      }

      products = (data || []).map(p => ({
        id: p.id,
        name: p.name || '',
        description: p.description || '',
        category: p.category || '',
        // store both numeric currencies; fall back to legacy 'price' if present
        price_qar: Number(p.price_qar ?? p.price ?? 0),
        price_bdt: Number(p.price_bdt ?? p.price ?? 0),
        price_legacy: Number(p.price ?? 0),
        sku: p.sku || '',
        image: (p.image_urls && p.image_urls[0]) ? p.image_urls[0] : ''
      }));

      await loadFuse();
      if (window.Fuse) {
        fuse = new window.Fuse(products, {
          includeScore: true,
          shouldSort: true,
          threshold: 0.45,
          keys: [
            { name: 'name', weight: 0.5 },
            { name: 'description', weight: 0.3 },
            { name: 'category', weight: 0.1 },
            { name: 'sku', weight: 0.1 }
          ]
        });
      }

      if (statusEl) statusEl.textContent = `Loaded ${products.length} products. Type a natural query!`;
    } catch (err) {
      console.error(err);
      if (statusEl) statusEl.textContent = 'Failed to load product data.';
    }
  }

  /* -------------------------
     AI rewriter (same as you had)
  ------------------------- */
  async function rewriteQueryWithAI(userInput) {
    try {
      const res = await fetch('https://rongtuli-smoky.vercel.app//api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message: `You are a shopping assistant. Convert this user search phrase into short keyword phrases (comma-separated). Return only the keywords, no extra text.\n\n${userInput}`
        })
      });
      const data = await res.json();
      return data.reply || userInput;
    } catch (err) {
      console.warn('AI rewrite failed, using raw input', err);
      return userInput;
    }
  }

  /* -------------------------
     Suggestions (Fuse-based)
  ------------------------- */
  function getLiveSuggestions(partial, limit = 8) {
    if (!partial || !fuse) return [];
    const res = fuse.search(partial, { limit });
    const seen = new Set();
    const suggestions = [];
    for (const r of res) {
      const item = r.item;
      const name = item.name || '';
      if (name && !seen.has(name.toLowerCase())) {
        suggestions.push({ text: name, item });
        seen.add(name.toLowerCase());
      }
      if (item.category && !seen.has(item.category.toLowerCase())) {
        suggestions.push({ text: item.category, item: null });
        seen.add(item.category.toLowerCase());
      }
      if (suggestions.length >= limit) break;
    }
    return suggestions;
  }

  // render suggestion dropdown
  let suggestionIndex = -1;
  function showSuggestions(list) {
    if(!suggestionsEl) return;
    suggestionsEl.innerHTML = '';
    suggestionIndex = -1;
    if (!list || list.length === 0) { suggestionsEl.style.display = 'none'; suggestionsEl.classList.remove('in'); return; }
    list.forEach((s, idx) => {
      const div = document.createElement('div');
      div.className = 'suggestion-item';
      div.textContent = s.text;
      const countSpan = document.createElement('span');
      countSpan.style.fontSize = '12px';
      countSpan.style.color = '#6b7280';
      countSpan.textContent = s.item ? (s.item.category || '') : '';
      div.appendChild(countSpan);
      div.addEventListener('click', () => {
        if (searchInput) searchInput.value = s.text;
        suggestionsEl.style.display = 'none';
        suggestionsEl.classList.remove('in');
        doSearch(s.text);
      });
      suggestionsEl.appendChild(div);
    });
    suggestionsEl.style.display = 'block';
    requestAnimationFrame(()=> {
      suggestionsEl.classList.add('in');
      const items = suggestionsEl.querySelectorAll('.suggestion-item');
      items.forEach((it, i) => setTimeout(()=> it.classList.add('visible'), i * 60));
    });
  }

  function moveSuggestion(delta) {
    if(!suggestionsEl) return;
    const items = suggestionsEl.querySelectorAll('.suggestion-item');
    if (!items.length) return;
    suggestionIndex = Math.max(0, Math.min(items.length - 1, suggestionIndex + delta));
    items.forEach((it, i) => it.classList.toggle('active', i === suggestionIndex));
    if (items[suggestionIndex]) {
      searchInput.value = items[suggestionIndex].firstChild.textContent;
    }
  }

  /* -------------------------
     Search & render logic (currency-aware)
  ------------------------- */
  async function doSearch(q) {
    q = (q || '').trim();
    if (suggestionsEl) { suggestionsEl.style.display = 'none'; suggestionsEl.classList.remove('in'); }
    if (!q) {
      renderResults([]);
      if (statusEl) statusEl.textContent = 'Enter search text.';
      return;
    }
    if (statusEl) statusEl.textContent = `Thinking about: "${q}"...`;

    const aiQuery = await rewriteQueryWithAI(q);
    let hits = [];
    if (fuse) {
      hits = fuse.search(aiQuery, { limit: 50 }).map(r => ({ ...r.item, score: r.score }));
    } else {
      const term = aiQuery.toLowerCase();
      hits = products.filter(p =>
        (p.name + ' ' + p.description + ' ' + p.category)
          .toLowerCase()
          .includes(term)
      ).slice(0, 50);
    }

    if (!hits || hits.length === 0) {
      if (statusEl) statusEl.textContent = `No exact matches for "${q}". Showing closest alternatives.`;
      if (fuse) {
        const loose = new window.Fuse(products, { keys: ['name','description','category'], threshold: 0.7 });
        const alt = loose.search(q, { limit: 12 }).map(r => r.item);
        renderNoResultsWithAlternatives(q, alt);
      } else {
        renderNoResultsWithAlternatives(q, []);
      }
      return;
    }

    if (statusEl) statusEl.textContent = `Found ${hits.length} results for "${q}".`;
    renderResults(hits.map(h => ({ ...h })));
  }

  function renderNoResultsWithAlternatives(q, alternatives) {
    if(!resultsEl) return;
    resultsEl.innerHTML = '';
    const box = document.createElement('div');
    box.className = 'no-results';
    box.innerHTML = `<div style="font-weight:800;margin-bottom:6px">No matching items found for "<em>${escapeHtml(q)}</em>"</div>
      <div style="color:#6b7280">We found these similar items — maybe one fits:</div>`;
    resultsEl.appendChild(box);

    requestAnimationFrame(()=> {
      resultsEl.classList.add('in');
      box.classList.add('in');
    });

    if (!alternatives || alternatives.length === 0) {
      const msg = document.createElement('div');
      msg.style.padding = '12px';
      msg.style.color = '#6b7280';
      msg.textContent = 'No close alternatives found. Try different words (e.g., "hand accessory", "glove", "bangle").';
      resultsEl.appendChild(msg);
      return;
    }

    const sel = getSelectedCurrency();

    alternatives.forEach((p, idx) => {
      const displayVal = sel === 'BDT' ? (p.price_bdt || p.price_qar || p.price_legacy) : (p.price_qar || p.price_bdt || p.price_legacy);
      const card = document.createElement('div');
      card.className = 'product-card';
      card.innerHTML = `
        <div class="product-thumb"><img src="${p.image || 'https://via.placeholder.com/200x150?text=No+Image'}" alt="${escapeHtml(p.name)}"></div>
        <div class="product-name">${escapeHtml(p.name)}</div>
        <div class="product-price">${formatPriceWithLabel(displayVal)}</div>
        <div class="meta">${escapeHtml(p.category || '')} ${p.sku ? '• SKU: ' + escapeHtml(p.sku) : ''}</div>
        <div class="small">${escapeHtml((p.description||'').slice(0,100))}</div>
        <button class="add-btn">Add to Cart</button>
      `;
      // wire add + navigation with exit animation
      card.querySelector('.add-btn').addEventListener('click', e => {
        e.stopPropagation();
        addToCartFromProductObj(p);
        showToast('Added to cart');
        triggerCartBump();
      });
      card.addEventListener('click', (e) => {
        e.stopPropagation();
        animateExitThenNavigate(`product.html?id=${p.id}`);
      });

      resultsEl.appendChild(card);

      const img = card.querySelector('.product-thumb img');
      img.setAttribute('data-loading','true');
      img.addEventListener('load', ()=> img.classList.add('in'));
      setTimeout(()=> { img.classList.add('in'); card.classList.add('in'); }, 220 + idx * 80);
    });
  }

  function renderResults(list) {
    if(!resultsEl) return;
    resultsEl.innerHTML = '';
    if (!list || list.length === 0) {
      resultsEl.innerHTML = '<div class="no-results in">No matching items found. Try different words.</div>';
      requestAnimationFrame(()=> resultsEl.classList.add('in'));
      return;
    }

    requestAnimationFrame(()=> resultsEl.classList.add('in'));

    const sel = getSelectedCurrency();

    list.forEach((p, idx) => {
      // p may be the product object (from products array) or come from fuse (same shape)
      const displayVal = sel === 'BDT' ? (p.price_bdt || p.price_qar || p.price_legacy || 0) : (p.price_qar || p.price_bdt || p.price_legacy || 0);

      const card = document.createElement('div');
      card.className = 'product-card';
      card.innerHTML = `
        <div class="product-thumb">
          <img src="${p.image || 'https://via.placeholder.com/200x150?text=No+Image'}" alt="${escapeHtml(p.name)}">
        </div>
        <div class="product-name">${escapeHtml(p.name)}</div>
        <div class="product-price">${formatPriceWithLabel(displayVal)}</div>
        <div class="meta">${escapeHtml(p.category || '')} ${p.sku ? '• SKU: ' + escapeHtml(p.sku) : ''}</div>
        <div class="small">${escapeHtml((p.description || '').slice(0,100))}</div>
        <button class="add-btn">Add to Cart</button>
      `;

      const addBtn = card.querySelector('.add-btn');
      addBtn.addEventListener('click', e => {
        e.stopPropagation();
        addToCartFromProductObj(p);
        showToast('Added to cart');
        triggerCartBump();
      });

      card.addEventListener('click', (e) => {
        e.stopPropagation();
        animateExitThenNavigate(`product.html?id=${p.id}`);
      });

      resultsEl.appendChild(card);

      const img = card.querySelector('.product-thumb img');
      img.setAttribute('data-loading','true');
      img.addEventListener('load', ()=> img.classList.add('in'));
      setTimeout(()=> { img.classList.add('in'); card.classList.add('in'); }, 220 + idx * 80);
    });
  }

  function showToast(text) {
    const t = document.createElement('div');
    t.textContent = text;
    Object.assign(t.style, {
      position: 'fixed',
      bottom: '20px',
      left: '50%',
      transform: 'translateX(-50%)',
      background: '#143047',
      color: '#fff',
      padding: '8px 12px',
      borderRadius: '8px',
      zIndex: 9999
    });
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 1500);
  }

  /* -------------------------
     Cart logic (currency-aware) — integrated & kept behavior
  ------------------------- */
  const WHATSAPP_NUMBER = '97451707046';
  let cart = JSON.parse(localStorage.getItem('cart') || '[]');

  // migrate legacy cart items to include price_qar and price_bdt
  (function migrateCart(){
    if(!Array.isArray(cart)) cart = [];
    cart = cart.map(it => {
      if(!it) return it;
      if(typeof it.price_qar === 'undefined' && typeof it.price_bdt === 'undefined') {
        const legacy = Number(it.price || 0);
        it.price_qar = legacy;
        it.price_bdt = legacy;
        delete it.price;
      } else {
        it.price_qar = Number(it.price_qar || it.price || 0);
        it.price_bdt = Number(it.price_bdt || it.price || it.price_qar || 0);
      }
      return it;
    });
    localStorage.setItem('cart', JSON.stringify(cart));
  })();

  function saveCart(){
    localStorage.setItem('cart', JSON.stringify(cart));
    localStorage.setItem('cart_last_update', Date.now());
    renderCart();
    updateCartCount();
  }

  // DOM refs used by cart (guarded already above but re-select locally to be safe)
  const cartToggleEl = document.getElementById('cart-toggle');
  const cartElDom = document.getElementById('cart');
  const cartRowsDom = document.getElementById('cart-rows');
  const subtotalElDom = document.getElementById('subtotal');
  const shippingElDom = document.getElementById('shipping');
  const totalElDom = document.getElementById('total');
  const checkoutBtn = document.getElementById('checkout-btn');
  const cartCloseFooter = document.getElementById('cart-close-footer');

  function updateCartCount(){
    const qty = cart.reduce((s,i)=> s + (Number(i.quantity)||0), 0);
    const badge = cartToggleEl && cartToggleEl.querySelector('.count');
    if (badge) badge.textContent = qty;
    cartToggleEl && cartToggleEl.setAttribute('aria-label', `Open cart — ${qty} items`);
  }

  function renderCart(){
    if(!cartRowsDom) return;
    cartRowsDom.innerHTML = '';
    if(!cart || cart.length === 0){
      cartRowsDom.textContent = 'Cart is empty.';
    } else {
      cart.forEach((it, i) => {
        const row = document.createElement('div');
        row.className = 'cart-row';

        const img = document.createElement('img');
        img.className = 'cart-img';
        img.src = it.image || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48"><rect width="100%" height="100%" fill="%23eee"/></svg>';
        img.alt = it.name || 'product';

        const txt = document.createElement('div');
        txt.className = 'cart-text';
        const title = document.createElement('div');
        title.textContent = it.name || 'Product';

        const sel = getSelectedCurrency();
        const perUnit = sel === 'BDT' ? (Number(it.price_bdt || it.price_qar || 0)) : (Number(it.price_qar || it.price_bdt || 0));
        const meta = document.createElement('div');
        meta.textContent = `${formatPriceWithLabel(perUnit)} × ${it.quantity}`;

        txt.appendChild(title);
        txt.appendChild(meta);

        const controls = document.createElement('div');
        controls.className = 'cart-controls';

        const inc = document.createElement('button'); inc.className = 'small-btn icon'; inc.textContent = '+'; inc.addEventListener('click', (e) => { e.stopPropagation(); cart[i].quantity++; saveCart(); });
        const dec = document.createElement('button'); dec.className = 'small-btn icon'; dec.textContent = '-'; dec.addEventListener('click', (e) => { e.stopPropagation(); if (cart[i].quantity > 1) cart[i].quantity--; else cart.splice(i,1); saveCart(); });
        const rem = document.createElement('button'); rem.className = 'small-btn'; rem.textContent = 'Remove'; rem.addEventListener('click', (e) => { e.stopPropagation(); cart.splice(i,1); saveCart(); });

        controls.appendChild(inc); controls.appendChild(dec); controls.appendChild(rem);

        row.appendChild(img);
        row.appendChild(txt);
        row.appendChild(controls);

        cartRowsDom.appendChild(row);
      });
    }

    const sel = getSelectedCurrency();
    const subtotal = cart.reduce((s,i)=> s + ( (sel === 'BDT' ? Number(i.price_bdt||i.price_qar||0) : Number(i.price_qar||i.price_bdt||0)) ) * i.quantity, 0);
    const shipping = subtotal > 0 ? 10 : 0;
    if (subtotalElDom) subtotalElDom.textContent = 'Subtotal: ' + formatPriceWithLabel(subtotal);
    if (shippingElDom) shippingElDom.textContent = 'Shipping: ' + formatPriceWithLabel(shipping);
    if (totalElDom) totalElDom.textContent = 'Total: ' + formatPriceWithLabel(subtotal + shipping);
  }

  // animate cart open/close (non-destructive)
  function animateCartOpen(){
    if(!cartElDom) return;
    cartElDom.classList.remove('hidden','anim-out');
    void cartElDom.offsetWidth;
    cartElDom.classList.add('anim-in');
    cartElDom.style.display = 'block';
    cartElDom.setAttribute('aria-hidden','false');
    cartToggleEl && cartToggleEl.setAttribute('aria-expanded','true');
    cartElDom.scrollTop = 0;
  }
  function animateCartClose(){
    if(!cartElDom) return;
    cartElDom.classList.remove('anim-in');
    cartElDom.classList.add('anim-out');
    cartElDom.setAttribute('aria-hidden','true');
    cartToggleEl && cartToggleEl.setAttribute('aria-expanded','false');
    setTimeout(()=> {
      if (cartElDom.classList.contains('anim-out')) {
        cartElDom.classList.add('hidden');
        cartElDom.classList.remove('anim-out');
        cartElDom.style.display = 'none';
      }
    }, 260);
  }
  function openCart(){ animateCartOpen(); }
  function closeCart(){ animateCartClose(); }
  function toggleCart(){ if(!cartElDom) return; if(cartElDom.classList.contains('hidden')) animateCartOpen(); else animateCartClose(); }

  cartToggleEl && cartToggleEl.addEventListener('click', toggleCart);
  cartCloseFooter && cartCloseFooter.addEventListener('click', closeCart);
  checkoutBtn && checkoutBtn.addEventListener('click', () => checkoutWhatsApp());

  window.addEventListener('storage', (e) => {
    if(e.key === 'cart' || e.key === 'cart_last_update'){
      try { cart = JSON.parse(localStorage.getItem('cart') || '[]'); } catch(err){ cart = []; }
      renderCart();
      updateCartCount();
      triggerCartBump();
    }
  });

  // WhatsApp checkout (currency-aware)
  function checkoutWhatsApp() {
    if (!cart || cart.length === 0) { alert('Cart is empty.'); return; }
    const sel = getSelectedCurrency();
    let text = `Order request — items (${sel}):\n\n`;
    cart.forEach(it => {
      const unit = sel === 'BDT' ? Number(it.price_bdt || it.price_qar || 0) : Number(it.price_qar || it.price_bdt || 0);
      text += `${it.name} — ${sel} ${unit.toFixed(2)} × ${it.quantity}\n`;
    });
    const subtotal = cart.reduce((s,i)=> s + ( (sel === 'BDT' ? Number(i.price_bdt||i.price_qar||0) : Number(i.price_qar||i.price_bdt||0)) ) * i.quantity, 0);
    const shipping = subtotal > 0 ? 10 : 0;
    text += `\nSubtotal: ${sel} ${subtotal.toFixed(2)}\nShipping: ${sel} ${shipping.toFixed(2)}\nTotal: ${sel} ${(subtotal+shipping).toFixed(2)}`;
    const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(text)}`;
    window.open(url, '_blank');
  }

  /* -------------------------
     addToCart helpers:
     - addToCartFromProductObj(p) accepts product objects from `products`, `fuse` result, or rendered list
     - it stores price_qar & price_bdt on cart item so totals stay stable even if currency later changes
  ------------------------- */
  function addToCartFromProductObj(p) {
    let found = cart.find(i => i.id === p.id);
    const p_qar = Number(p.price_qar ?? p.price_legacy ?? 0);
    const p_bdt = Number(p.price_bdt ?? p.price_legacy ?? 0);
    if (found) {
      found.quantity = Number(found.quantity || 0) + 1;
      // ensure prices present
      found.price_qar = Number(found.price_qar || p_qar);
      found.price_bdt = Number(found.price_bdt || p_bdt);
    } else {
      const entry = {
        id: p.id,
        name: p.name || 'Product',
        price_qar: p_qar,
        price_bdt: p_bdt,
        quantity: 1,
        image: p.image || '',
        link: window.location.href
      };
      cart.push(entry);
    }
    saveCart();
    openCart();
  }

  function addToCartLegacy(p) {
    // kept for compatibility with any legacy call that passes { price } directly
    let found = cart.find(i => i.id === p.id);
    const p_qar = Number(p.price || 0);
    if (found) {
      found.quantity = Number(found.quantity || 0) + 1;
      found.price_qar = Number(found.price_qar || p_qar);
      found.price_bdt = Number(found.price_bdt || p_qar);
    } else {
      cart.push({
        id: p.id,
        name: p.name || 'Product',
        price_qar: p_qar,
        price_bdt: p_qar,
        quantity: 1,
        image: p.image || '',
        link: window.location.href
      });
    }
    saveCart();
    openCart();
  }

  // helpers used earlier in page
  function triggerCartBump(){
    if(!cartToggleEl) return;
    cartToggleEl.classList.remove('bump');
    void cartToggleEl.offsetWidth;
    cartToggleEl.classList.add('bump');
    setTimeout(()=> cartToggleEl.classList.remove('bump'), 900);
  }

  /* -------------------------
     Wiring: search button, clear, suggestions typing, keyboard behaviour
  ------------------------- */
  const searchBtn = document.getElementById('searchBtn');
  const clearBtn = document.getElementById('clearBtn');
  if (searchBtn && searchInput) searchBtn.addEventListener('click', () => doSearch(searchInput.value));
  if (clearBtn && searchInput) clearBtn.addEventListener('click', () => { searchInput.value = ''; renderResults([]); if(statusEl) statusEl.textContent = ''; if(suggestionsEl){ suggestionsEl.style.display='none'; suggestionsEl.classList.remove('in'); } });

  const onType = debounce(async () => {
    const q = (searchInput && searchInput.value || '').trim();
    if (!q) { if(suggestionsEl){ suggestionsEl.style.display = 'none'; suggestionsEl.classList.remove('in'); } return; }
    const sug = getLiveSuggestions(q, 8);
    showSuggestions(sug);
  }, 180);

  if (searchInput) {
    searchInput.addEventListener('input', onType);

    searchInput.addEventListener('keydown', (e) => {
      const visible = suggestionsEl && suggestionsEl.style.display !== 'none';
      if (visible && (e.key === 'ArrowDown' || e.key === 'ArrowUp' || e.key === 'Enter' || e.key === 'Escape')) {
        e.preventDefault();
        if (e.key === 'ArrowDown') moveSuggestion(1);
        else if (e.key === 'ArrowUp') moveSuggestion(-1);
        else if (e.key === 'Enter') {
          const active = suggestionsEl && suggestionsEl.querySelector('.suggestion-item.active');
          if (active) { active.click(); }
          else doSearch(searchInput.value);
        } else if (e.key === 'Escape') { suggestionsEl.style.display = 'none'; suggestionsEl.classList.remove('in'); }
      } else if (e.key === 'Enter') {
        doSearch(searchInput.value);
      }
    });
  }

  document.addEventListener('click', (ev) => {
    const searchBar = document.querySelector('.search-bar');
    if (!searchBar || !searchBar.contains(ev.target)) {
      if (suggestionsEl) { suggestionsEl.style.display = 'none'; suggestionsEl.classList.remove('in'); }
    }
  });

  /* -------------------------
     Initial load + cart render
  ------------------------- */
  loadProducts();
  try { cart = JSON.parse(localStorage.getItem('cart') || '[]'); } catch(err){ cart = []; }
  renderCart();
  updateCartCount();

  /* -------------------------
     Small UI helpers & BFCACHE restore handling (kept mostly as-is)
  ------------------------- */
  function animateExitThenNavigate(href) {
    document.documentElement.classList.add('page-exit');
    document.querySelectorAll('.product-card').forEach(pc => pc.classList.add('out'));
    setTimeout(()=> { window.location.href = href; }, 380);
  }

  (function enhanceGoBack(){
    const anchors = Array.from(document.querySelectorAll('.wrap a'));
    const goBack = anchors.find(a => a.textContent && a.textContent.trim().startsWith('←'));
    if(!goBack) return;
    goBack.addEventListener('click', function(e){
      e.preventDefault();
      document.documentElement.classList.add('page-exit');
      setTimeout(()=>{
        try {
          if (history.length > 1) history.back();
          else window.location.href = 'index.html';
        } catch(err) {
          window.location.href = 'index.html';
        }
      }, 380);
    }, { capture: true });
  })();

  requestAnimationFrame(()=> document.querySelector('.navbar') && document.querySelector('.navbar').classList.add('ready'));

  // expose debug hooks
  window._rongtuli_search = { products, doSearch, getLiveSuggestions, cart, setSelectedCurrency, getSelectedCurrency };

  // pageshow restore handling (keeps your original cleanup but also re-renders cart/prices to current currency)
  (function handlePageRestore() {
    window.addEventListener('pageshow', (event) => {
      document.documentElement.classList.remove('page-exit');
      document.querySelectorAll('.product-card.out').forEach(el => el.classList.remove('out'));
      const cartElR = document.getElementById('cart');
      if (cartElR) {
        cartElR.classList.remove('anim-out');
        if (cartElR.classList.contains('hidden')) { cartElR.style.display = 'none'; } else { cartElR.style.display = 'block'; }
      }
      const suggestionsE = document.getElementById('suggestions');
      if (suggestionsE) {
        suggestionsE.style.display = 'none';
        suggestionsE.classList.remove('in');
        suggestionsE.querySelectorAll('.suggestion-item.visible, .suggestion-item.active')
          .forEach(it => it.classList.remove('visible', 'active'));
      }
      if (resultsEl) {
        resultsEl.classList.remove('in');
        if (resultsEl.children.length) requestAnimationFrame(()=> resultsEl.classList.add('in'));
        else { resultsEl.style.opacity = ''; resultsEl.style.transform = ''; }
      }

      try { cart = JSON.parse(localStorage.getItem('cart') || '[]'); } catch (err) { cart = []; }
      renderCart && typeof renderCart === 'function' && renderCart();
      updateCartCount && typeof updateCartCount === 'function' && updateCartCount();

      if ((!window.products || !window.products.length) && typeof loadProducts === 'function') {
        loadProducts().catch(()=>{/* ignore */});
      } else {
        if (!window.fuse && typeof window.Fuse !== 'undefined') {
          try {
            window.fuse = new window.Fuse(window.products || [], {
              includeScore: true,
              shouldSort: true,
              threshold: 0.45,
              keys: [
                { name: 'name', weight: 0.5 },
                { name: 'description', weight: 0.3 },
                { name: 'category', weight: 0.1 },
                { name: 'sku', weight: 0.1 }
              ]
            });
          } catch (e) { /* ignore */ }
        }
      }

      const nav = document.querySelector('.navbar');
      if (nav) {
        nav.classList.remove('ready');
        requestAnimationFrame(() => nav.classList.add('ready'));
      }
    });
  })();
</script>

</body>
</html>
