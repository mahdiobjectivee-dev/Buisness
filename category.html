<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <title>Rongtuli-Categorie</title>

 <style>
  /* Make sizing predictable */
  *,
  *::before,
  *::after { box-sizing: border-box; }

  body { font-family: "Poppins", sans-serif; background-color: #f6f8fb; margin:0; padding:0; }
  .header { display:flex; justify-content:center; align-items:center; padding:1rem 0; }
  .logo{ height:90px; }
  .navbar { background-color:#dce4cc; display:flex; justify-content:center; flex-wrap:wrap; gap:2rem; padding:0.7rem 1rem; border-radius:13px; margin:0 auto; width:fit-content; }
  .navbar a{ text-decoration:none; font-weight:600; color:#415a4a; }

  :root{
    --card:#ffffff;
    --accent:#6aa8d6;
    --accent-dark:#6aa8d6;
    --muted:#7b8794;
    --text:#7092b0;
    --radius:14px;
    --card-radius:12px;
    --shadow: 0 8px 26px rgba(16,24,40,0.06);
    --soft-shadow: 0 6px 18px rgba(15,30,40,0.06);
    --cart-width:340px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;

    /* animation tuning */
    --anim-fast: 260ms;
    --anim-medium: 620ms;
    --anim-slow: 1100ms;
    --easing: cubic-bezier(.2,.9,.2,1);
  }

  .wrap { max-width:1000px; margin:18px auto; padding:0 16px; }
  h1.category-title { font-weight:800; color:var(--text); margin:8px 0 12px 0; text-align:left; }

  /* grid of all products: responsive, no big gaps */
  .products-grid {
  display: grid;
  gap: 18px;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  align-items: start;
  opacity: 0;
  transform: translateY(8px);
}

/* 2 per row on mobile (portrait phones like 375px–480px) */
@media (max-width: 600px) {
  .products-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    padding: 0 6px;
  }

  .product-card {
    padding: 12px;
  }

  .product-image {
    height: 120px;
  }

  .product-name {
    font-size: 13px;
    max-width: 100%;
  }

  .product-price {
    font-size: 14px;
  }

  .add-btn {
    font-size: 13px;
    padding: 8px 10px;
  }
}

  .products-grid.in {
    opacity: 1;
    transform: translateY(0);
    transition: opacity var(--anim-medium) var(--easing), transform var(--anim-medium) var(--easing);
  }

  .product-card {
    background:var(--card);
    border-radius:var(--card-radius);
    padding:14px;
    text-align:center;
    box-shadow:var(--soft-shadow);
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:10px;
    transition:transform .18s, box-shadow .18s;
    cursor:pointer;

    /* start hidden for entrance */
    opacity: 0;
    transform: translateY(12px) scale(.995);
  }
  .product-card.in {
    opacity: 1;
    transform: translateY(0) scale(1);
    transition: transform var(--anim-medium) var(--easing), opacity var(--anim-medium) var(--easing);
  }
  .product-card.out {
    opacity: 0;
    transform: translateY(-8px) scale(.99);
    transition: transform var(--anim-fast) var(--easing), opacity var(--anim-fast) var(--easing);
  }

  .product-card:hover { transform:translateY(-6px); box-shadow: 0 18px 40px rgba(16,24,40,0.12); }

  .product-image { width:100%; max-width:260px; height:140px; object-fit:cover; border-radius:10px; box-shadow:0 6px 18px rgba(16,24,40,0.05), inset 0 1px 0 rgba(255,255,255,0.4); background:linear-gradient(180deg,#f8fbff,#fff); transition: transform 900ms var(--easing), filter 300ms linear; }
  .product-image[data-loading="true"]::after {
    content: '';
    position: absolute;
    inset: 0;
    display: block;
  }
  .product-name{ color:#7092b0; font-weight:800; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:220px; }
  .product-price{ color:var(--text); font-weight:800; font-size:18px; }
  .add-btn{ background:linear-gradient(180deg,var(--accent),var(--accent-dark)); color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:800; width:100%; box-shadow:0 8px 18px rgba(106,168,214,0.16); }
  footer{max-width:1000px;margin:28px auto;text-align:center;color:var(--muted)}

  /* Cart toggle and panel */
  /* Modern minimalist cart toggle */
  #cart-toggle {
    position: fixed;
    right: 22px;
    top: 22px;
    background: var(--accent);
    color: #fff;
    padding: 10px 14px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 14px;
    letter-spacing: 0.3px;
    box-shadow: 0 4px 14px rgba(0, 0, 0, 0.12);
    cursor: pointer;
    z-index: 11001; /* high to avoid overlap */
    display: flex;
    align-items: center;
    gap: 6px;
    border: none;
    transition: all 0.25s ease;
  }

  #cart-toggle:hover {
    background: var(--accent-dark);
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.18);
  }

  #cart-toggle .count {
    background: #fff;
    color: var(--accent-dark);
    padding: 2px 8px;
    border-radius: 999px;
    font-weight: 700;
    font-size: 12px;
  }

  /* Cart panel (clean + soft aesthetic) */
  #cart {
    position: fixed;
    right: 22px;
    top: 70px;
    width: var(--cart-width);
    max-height: calc(100vh - 96px);
    overflow: auto;
    background: #fff;
    border-radius: 14px;
    padding: 18px;
    box-shadow: 0 12px 40px rgba(0,0,0,0.12);
    z-index: 11000;
    transition: transform 0.25s ease, opacity 0.25s ease;
    -webkit-overflow-scrolling: touch;
    opacity: 1;
  }

  #cart.hidden {
    transform: translateY(-10px) scale(0.98);
    opacity: 0;
    pointer-events: none;
    display: none;
  }

  /* animate cart opening (soft scale + fade) */
  #cart.anim-in {
    transform: translateY(0) scale(1);
    opacity: 1;
    transition: transform var(--anim-fast) var(--easing), opacity var(--anim-fast) var(--easing);
  }
  #cart.anim-out {
    transform: translateY(-6px) scale(.99);
    opacity: 0;
    transition: transform var(--anim-fast) var(--easing), opacity var(--anim-fast) var(--easing);
  }

  #cart h2 {
    margin: 0 0 12px 0;
    color: var(--text);
    font-size: 16px;
    font-weight: 700;
  }

  /* Cart item rows */
  #cart-rows > div {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 0;
    border-bottom: 1px solid rgba(0, 0, 0, 0.06);
  }

  /* optional utility class for rows (if you add it in JS) */
  .cart-row { display:flex; align-items:center; gap:10px; padding:8px 0; }

  #cart-rows img {
    width: 56px;
    height: 56px;
    object-fit: cover;
    border-radius: 10px;
  }

  /* Buttons inside cart */
  #cart .small-btn {
    border: none;
    background: transparent;
    cursor: pointer;
    font-weight: 600;
    color: var(--accent);
    transition: color 0.2s ease;
  }

  #cart .small-btn:hover {
    color: var(--accent-dark);
  }

  /* Actions */
  .cart-actions {
    display: flex;
    gap: 8px;
    margin-top: 14px;
    justify-content: flex-end;
  }

  #subtotal,
  #shipping,
  #total {
    margin: 8px 0;
    font-weight: 600;
    color: var(--muted);
    font-size: 14px;
  }

  #total {
    color: var(--text);
    font-size: 16px;
  }

  /* --------------------------------------------------------------------
     Responsive: safer & cleaner mobile cart
     Note: original contained some media rules; kept intact but added no-breaking animation rules
     -------------------------------------------------------------------- */

  @media (max-width: 900px) {
    #cart {
      /* pin left & right so the browser calculates width reliably */
      left:50              px !important;
      right:  px;
      width: auto;
      max-width: calc(100% - 24px);
      top: auto;
      bottom: 90px;
      transform: none; /* avoid transform clipping quirks */
      border-radius: 12px;
      /* reduce max height a bit on mobile */
      max-height: calc(100vh - 120px);
    }

    #cart-toggle {
      bottom: 22px;
      top: auto;
      right: 12px;
      left: auto;
      padding: 12px 16px;
    }
  }

  @media (max-width: 600px) {
    /* respect safe area on modern phones and reduce paddings */
    #cart {
      max-height: calc(100vh - 140px);
      padding: calc(12px + env(safe-area-inset-top)) calc(12px + env(safe-area-inset-right)) calc(12px + env(safe-area-inset-bottom));
      left: 8px;
      right: 8px;
      bottom: 88px;
      border-radius: 12px;
    }

    #cart .cart-row { gap: 10px; padding: 8px 0; min-height: 48px; }
    #cart img { width: 48px; height: 48px; flex: 0 0 48px; }
    .small-btn { padding: 6px 6px; font-size: 12px; }
  }

  @media (max-width: 400px) {
    #cart { padding: 10px; left: 6px; right: 6px; bottom: 80px; }
    #cart h2 { font-size: 16px; }
    #cart .cart-text > div:first-child { font-size: 13px; }
    .product-name { max-width: 160px; }
  }


   /* AI search promo block (place before footer) */
.ai-promo {
  background: #fff;
  border-radius: 12px;
  padding: 18px;
  margin: 28px auto;
  box-shadow: 0 10px 30px rgba(16,24,40,0.06);
  max-width: 970px;
  display: flex;
  gap: 12px;
  align-items: center;
  justify-content: space-between;
  border: 1px solid #eef6fb;

  opacity: 0;
  transform: translateY(8px);
}
.ai-promo.in {
  opacity: 1;
  transform: translateY(0);
  transition: opacity var(--anim-medium) var(--easing), transform var(--anim-medium) var(--easing);
}
.ai-promo .left {
  display: flex;
  gap: 12px;
  align-items: center;
}
.ai-promo .left .icon {
  width: 56px;
  height: 56px;
  border-radius: 10px;
  background:#6aa8d628;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  color: #7092b0;
  font-size: 20px;

  /* subtle pulse */
  animation: aiPulse var(--anim-slow) var(--easing) infinite;
}
@keyframes aiPulse {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.03); opacity: 0.95; }
  100% { transform: scale(1); opacity: 1; }
}
.ai-promo h3 { margin: 0; font-size: 16px; font-weight: 800; color:#7092b0; }
.ai-promo p { margin: 2px 0 0 0; color:var(--muted); font-size:13px; }
.ai-promo .ai-btn {
  background: #6aa8d6;
  color: #fff;
  border: 0;
  padding: 10px 14px;
  border-radius: 10px;
  font-weight: 800;
  cursor: pointer;
  box-shadow: 0 8px 18px rgba(106,168,214,0.16);
}
@media (max-width:720px) {
  .ai-promo {
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: 14px;
    gap: 12px;
    margin: 20px 12px;
  }
  .ai-promo .left {
    display: flex;
    gap: 10px;
    align-items: center;
    justify-content: center;
    width: 100%;
  }
  .ai-promo .left .icon {
    width: 48px;
    height: 48px;
    font-size: 18px;
    flex: 0 0 48px;
  }
  .ai-promo h3 { margin: 0; font-size: 15px; line-height: 1.15; }
  .ai-promo p { margin: 4px 0 0 0; font-size: 13px; color: var(--muted); }
  .ai-promo .ai-btn {
    display: block;
    width: calc(100% - 24px);
    max-width: 420px;
    margin: 6px auto 0;
    padding: 12px 14px;
    font-size: 15px;
  }
}
@media (max-width:420px) {
  .ai-promo .left { flex-direction: column; gap: 8px; align-items: center; }
  .ai-promo .left .icon { width: 56px; height: 56px; font-size: 20px; }
  .ai-promo { padding: 12px; gap: 10px; margin: 16px 10px; }
  .ai-promo .ai-btn { width: 100%; padding: 12px; }
}

  /* page-level exit: fade everything out quickly before navigation */
  .page-exit .wrap,
  .page-exit .navbar,
  .page-exit .header,
  .page-exit .ai-promo {
    opacity: 0;
    transform: translateY(-8px) scale(.997);
    transition: opacity var(--anim-fast) var(--easing), transform var(--anim-fast) var(--easing);
  }

  /* navbar links stagger in */
  .navbar a { opacity: 0; transform: translateY(6px); display:inline-block; }
  .navbar.ready a { animation: navIn var(--anim-medium) var(--easing) forwards; }
  .navbar.ready a:nth-child(1) { animation-delay: 80ms; }
  .navbar.ready a:nth-child(2) { animation-delay: 180ms; }
  .navbar.ready a:nth-child(3) { animation-delay: 280ms; }
  @keyframes navIn { to { opacity:1; transform: translateY(0); } }

  /* Respect reduced motion */
  @media (prefers-reduced-motion: reduce) {
    * { animation: none !important; transition: none !important; }
    .product-card, .products-grid, .ai-promo { opacity: 1 !important; transform: none !important; }
  }

  /* Helpful debugging utility (uncomment while testing) */
  /* #cart { outline: 2px dashed rgba(255,0,0,0.15); } */
/* AI search promo block (place before footer) */
.ai-promo {
  background: #fff;
  border-radius: 12px;
  padding: 18px;
  margin: 28px auto;
  box-shadow: 0 10px 30px rgba(16,24,40,0.06);
  max-width: 970px;
  display: flex;
  gap: 12px;
  align-items: center;
  justify-content: space-between;
  border: 1px solid #eef6fb;

  /* start hidden until product content has animated in */
  opacity: 0;
  transform: translateY(8px);
}
.ai-promo.in { opacity: 1; transform: translateY(0); transition: opacity var(--anim-med) var(--easing), transform var(--anim-med) var(--easing); }

.ai-promo .left {
  display: flex;
  gap: 12px;
  align-items: center;
}
.ai-promo .left .icon {
  width: 56px;
  height: 56px;
  border-radius: 10px;
  background:#6aa7d628;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  color: #7092b0;
  font-size: 20px;
  transform-origin: center;
  animation: aiPulse var(--anim-slow) var(--easing) infinite;
}

@keyframes aiPulse {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.04); opacity: 0.94; }
  100% { transform: scale(1); opacity: 1; }
}

.ai-promo h3 { margin: 0; font-size: 16px; font-weight: 800; color:#7092b0; }
.ai-promo p { margin: 2px 0 0 0; color:var(--muted); font-size:13px; }
.ai-promo .ai-btn {
  background: #6aa8d6;
  color: #fff;
  border: 0;
  padding: 10px 14px;
  border-radius: 10px;
  font-weight: 800;
  cursor: pointer;
  box-shadow: 0 8px 18px rgba(106,168,214,0.16);
}


</style>

</head>
<body>

  <header class="header"><a href="index.html">
  <img src="assets/logo.png" alt="Rongtuli Logo" class="logo" />
</a></header>
  <nav class="navbar">
    <a href="index.html">Sarees</a>
    <a href="index.html">Creams</a>

    <a href="index.html">Hair Bands</a>
  </nav>

  <div class="wrap">
<a href="#" 
   style="text-decoration:none;color:var(--muted)" 
   onclick="(function(e){
     e.preventDefault();
     try {
       // if there's a previous page in history -> go back
       if (history.length > 1) {
         history.back();
       } else {
         // fallback if opened directly / no history
         window.location.href = 'index.html';
       }
     } catch(err) {
       // fallback on error
       window.location.href = 'index.html';
     }
   })(event);">
  ← Go Back
</a>
    <h1 id="category-title" class="category-title">Category</h1>
    <div id="products-grid" class="products-grid">Loading...</div>

    <!-- AI search promo: "Can't find what you want?" -->
<div class="ai-promo" id="aiPromo">
  <div class="left">
    <div class="icon">AI</div>
    <div>
      <h3>Can't find what you want?</h3>
      <p>Try our smart AI search — describe what you need in plain words and we’ll suggest products.</p>
    </div>
  </div>

  <div>
    <button class="ai-btn" id="openAISearch">Try AI Search</button>
  </div>
  
</div>
     <footer id="foot">© <span id="year"></span> Rongtuli</footer>
  </div>

  <button id="cart-toggle" aria-expanded="false" title="Open cart">Cart <span class="count">0</span></button>
  <div id="cart" class="hidden" aria-hidden="true">
    <h2>Your Cart</h2>
    <div id="cart-rows"></div>
    <p id="subtotal"></p>
    <p id="shipping"></p>
    <p id="total"></p>
    <div class="cart-actions">
      <button id="checkout-btn" class="add-btn" style="width:auto;padding:8px 12px;">Checkout via WhatsApp</button>
      <button id="cart-close" class="small-btn">Close</button>
    </div>
  </div>

 <script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
  const SUPABASE_URL      = 'https://qhslurjvanppitwuuxtv.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFoc2x1cmp2YW5wcGl0d3V1eHR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NTg0MjEsImV4cCI6MjA3NjUzNDQyMX0.8PNOewgJFDGVVIDdiEbdFE2x9Yzv29o2kdAANqaW1gA';
  const WHATSAPP_NUMBER   = '97451707046';
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // safe getter
  const $ = id => document.getElementById(id);

  // handle category title
  const params = new URLSearchParams(window.location.search);
  const catName = params.get('name') || '';
  if ($('category-title')) $('category-title').textContent = catName || 'Category';

  // elements (guarded)
  const productsGrid = $('products-grid');
  const cartEl = $('cart');
  const cartRows = $('cart-rows');
  const subtotalEl = $('subtotal');
  const shippingEl = $('shipping');
  const totalEl = $('total');
  const cartToggle = $('cart-toggle');

  // currency helpers
  const CURRENCY_KEY = 'site_currency';
  function getSelectedCurrency(){ return (localStorage.getItem(CURRENCY_KEY) || 'QAR').toUpperCase(); }
  function setSelectedCurrency(v){ localStorage.setItem(CURRENCY_KEY, (v||'QAR').toUpperCase()); }
  function formatPriceWithLabel(amount){
    const cur = getSelectedCurrency();
    const n = Number(amount) || 0;
    return (cur === 'BDT' ? 'BDT ' : 'QAR ') + n.toFixed(2);
  }
  // keep old signature for compatibility
  function formatPrice(n){ return formatPriceWithLabel(n); }

  // escape helper (used elsewhere)
  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"'`=\/]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#x60;','/':'&#x2F;'}[c])); }

  // cart (persisted)
  let cart = JSON.parse(localStorage.getItem('cart') || '[]');

  // migrate old cart items if necessary (ensure price_qar & price_bdt)
  (function migrateCart(){
    if(!Array.isArray(cart)) cart = [];
    let changed = false;
    cart = cart.map(it => {
      if(!it) return it;
      if(typeof it.price_qar === 'undefined' && typeof it.price_bdt === 'undefined'){
        const legacy = Number(it.price || 0);
        it.price_qar = legacy;
        it.price_bdt = legacy;
        delete it.price;
        changed = true;
      } else {
        it.price_qar = Number(it.price_qar || it.price || 0);
        it.price_bdt = Number(it.price_bdt || it.price || it.price_qar || 0);
      }
      return it;
    });
    if(changed) localStorage.setItem('cart', JSON.stringify(cart));
  })();

  function saveCart(){ localStorage.setItem('cart', JSON.stringify(cart)); renderCart(); updateCartCount(); }
  function updateCartCount(){
    if(!cartToggle) return;
    const countSpan = cartToggle.querySelector('.count');
    const qty = cart.reduce((s,i)=> s + (Number(i.quantity)||0), 0);
    if(countSpan) countSpan.textContent = qty;
    cartToggle.setAttribute('aria-label', `Open cart — ${qty} items`);
  }

  // animations and UI helpers (kept intact)
  function runEntranceAnimations() {
    const nav = document.querySelector('.navbar');
    if (nav) requestAnimationFrame(() => nav.classList.add('ready'));
    if (productsGrid) requestAnimationFrame(()=> setTimeout(()=> productsGrid.classList.add('in'), 160));
    const promo = $('aiPromo');
    if (promo) setTimeout(()=> promo.classList.add('in'), 260);
  }

  function animateExitThenNavigate(href) {
    document.documentElement.classList.add('page-exit');
    document.querySelectorAll('.product-card').forEach(pc => pc.classList.add('out'));
    setTimeout(() => { window.location.href = href; }, 420);
  }

  function animateCartOpen() {
    if(!cartEl) return;
    cartEl.classList.remove('hidden');
    cartEl.classList.remove('anim-out');
    void cartEl.offsetWidth;
    cartEl.classList.add('anim-in');
    cartEl.setAttribute('aria-hidden','false');
    if(cartToggle) cartToggle.setAttribute('aria-expanded','true');
  }
  function animateCartClose() {
    if(!cartEl) return;
    cartEl.classList.remove('anim-in');
    cartEl.classList.add('anim-out');
    cartEl.setAttribute('aria-hidden','true');
    if(cartToggle) cartToggle.setAttribute('aria-expanded','false');
    setTimeout(()=> {
      if (cartEl.classList.contains('anim-out')) {
        cartEl.classList.add('hidden');
        cartEl.classList.remove('anim-out');
      }
    }, 260);
  }

  // load products in category (currency-aware)
  async function loadCategory() {
    if(!productsGrid) return;
    productsGrid.textContent = 'Loading...';
    const { data, error } = await supabase.from('products').select('*').eq('category', catName).order('created_at', { ascending:false });
    if (error) { productsGrid.textContent = 'Error loading category.'; console.error(error); return; }
    if (!data || data.length === 0) { productsGrid.innerHTML = '<div class="small">No products in this category.</div>'; runEntranceAnimations(); return; }

    // re-bind AI search button safely
    const openAISearchBtn = $('openAISearch');
    if(openAISearchBtn) openAISearchBtn.addEventListener('click', function () { window.location.href = 'search.html'; });

    productsGrid.innerHTML = '';
    data.forEach((p, index) => {
      const imgSrc = (p.image_urls && p.image_urls.length) ? p.image_urls[0] : '';
      const card = document.createElement('div');
      card.className = 'product-card';

      // click: animate out then navigate
      card.addEventListener('click', (e) => { animateExitThenNavigate(`product.html?id=${p.id}`); });

      const image = document.createElement('img');
      image.className = 'product-image';
      image.src = imgSrc || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="360" height="240"><rect width="100%" height="100%" fill="%23eee"/></svg>';
      image.alt = p.name || 'product';
      image.setAttribute('data-loading','true');
      image.addEventListener('load', ()=> image.removeAttribute('data-loading'));

      const name = document.createElement('div'); name.className = 'product-name'; name.textContent = p.name || 'Product';

      // currency-aware price display
      const sel = getSelectedCurrency();
      const qarVal = Number(p.price_qar ?? p.price ?? 0);
      const bdtVal = Number(p.price_bdt ?? p.price ?? 0);
      const displayVal = sel === 'BDT' ? (bdtVal || qarVal) : (qarVal || bdtVal);
      const price = document.createElement('div');
      price.className = 'product-price';
      price.textContent = formatPriceWithLabel(displayVal);

      const addBtn = document.createElement('button');
      addBtn.className = 'add-btn';
      addBtn.textContent = 'Add to Cart';
      addBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        // store both currency values on cart item
        const existing = cart.find(i => i.id === p.id);
        const p_qar = Number(p.price_qar ?? p.price ?? 0);
        const p_bdt = Number(p.price_bdt ?? p.price ?? 0);
        if (existing) existing.quantity++;
        else cart.push({
          id: p.id,
          name: p.name,
          price_qar: p_qar,
          price_bdt: p_bdt,
          image: imgSrc || '',
          quantity: 1,
          link: `${window.location.origin}/product.html?id=${p.id}`
        });
        saveCart();
        animateCartOpen();
      });

      card.appendChild(image);
      card.appendChild(name);
      card.appendChild(price);
      card.appendChild(addBtn);
      productsGrid.appendChild(card);

      // stagger reveal
      setTimeout(()=> card.classList.add('in'), 220 + index * 80);
    });

    setTimeout(()=> productsGrid.classList.add('in'), 160);
    const promo = $('aiPromo'); if(promo) setTimeout(()=> promo.classList.add('in'), 260);
    requestAnimationFrame(()=> { const nav = document.querySelector('.navbar'); if(nav) nav.classList.add('ready'); });
  }

  // cart rendering (currency-aware)
  function renderCart() {
    if(!cartRows) return;
    cartRows.innerHTML = '';
    if (cart.length === 0) {
      cartRows.textContent = 'Cart is empty.';
    } else {
      cart.forEach((it, i) => {
        const row = document.createElement('div');

        const img = document.createElement('img');
        img.src = it.image || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48"><rect width="100%" height="100%" fill="%23eee"/></svg>';
        img.alt = it.name;

        const txt = document.createElement('div');
        txt.style.flex = '1';
        // choose displayed price according to selected currency (keeps compatibility)
        const sel = getSelectedCurrency();
        const displayedUnit = sel === 'BDT' ? Number(it.price_bdt || it.price_qar || 0) : Number(it.price_qar || it.price_bdt || 0);
        txt.innerHTML = `<div style="font-weight:800">${it.name}</div><div style="font-size:13px;color:var(--muted)">${formatPriceWithLabel(displayedUnit)} × ${it.quantity}</div>`;

        const controls = document.createElement('div');
        controls.style.display='flex';
        controls.style.flexDirection='column';
        controls.style.gap='6px';
        controls.style.alignItems='flex-end';

        const inc = document.createElement('button'); inc.className='small-btn'; inc.textContent='+'; inc.addEventListener('click', ()=>{ cart[i].quantity++; saveCart(); });
        const dec = document.createElement('button'); dec.className='small-btn'; dec.textContent='-'; dec.addEventListener('click', ()=>{ if(cart[i].quantity>1) cart[i].quantity--; else cart.splice(i,1); saveCart(); });
        const rem = document.createElement('button'); rem.className='small-btn'; rem.textContent='Remove'; rem.addEventListener('click', ()=>{ cart.splice(i,1); saveCart(); });

        controls.appendChild(inc); controls.appendChild(dec); controls.appendChild(rem);
        row.appendChild(img); row.appendChild(txt); row.appendChild(controls);
        cartRows.appendChild(row);
      });
    }

    const sel = getSelectedCurrency();
    const subtotal = cart.reduce((s,i)=> s + ( (sel === 'BDT' ? Number(i.price_bdt||i.price_qar||0) : Number(i.price_qar||i.price_bdt||0)) ) * i.quantity, 0);
    const shipping = subtotal > 0 ? 10 : 0;
    if(subtotalEl) subtotalEl.textContent = 'Subtotal: ' + formatPriceWithLabel(subtotal);
    if(shippingEl) shippingEl.textContent = 'Shipping: ' + formatPriceWithLabel(shipping);
    if(totalEl) totalEl.textContent = 'Total: ' + formatPriceWithLabel(subtotal + shipping);
  }

  // WhatsApp checkout (currency-aware)
  function checkoutWhatsApp() {
    if (!cart || cart.length === 0) { alert('Cart is empty.'); return; }
    const sel = getSelectedCurrency();
    let text = `Order request — items (${sel}):\n\n`;
    cart.forEach(it => {
      const unit = sel === 'BDT' ? Number(it.price_bdt || it.price_qar || 0) : Number(it.price_qar || it.price_bdt || 0);
      text += `${it.name} — ${sel} ${unit.toFixed(2)} × ${it.quantity}\n`;
    });
    const subtotal = cart.reduce((s,i)=> s + ( (sel === 'BDT' ? Number(i.price_bdt||i.price_qar||0) : Number(i.price_qar||i.price_bdt||0)) ) * i.quantity, 0);
    const shipping = subtotal > 0 ? 10 : 0;
    text += `\nSubtotal: ${sel} ${subtotal.toFixed(2)}\nShipping: ${sel} ${shipping.toFixed(2)}\nTotal: ${sel} ${(subtotal+shipping).toFixed(2)}`;
    const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(text)}`;
    window.open(url, '_blank');
  }

  // cart open/close toggle (guarded event wiring)
  function openCart() { animateCartOpen(); }
  function closeCart() { animateCartClose(); }
  function toggleCart() { if(!cartEl) return; if(cartEl.classList.contains('hidden')) animateCartOpen(); else animateCartClose(); }

  const checkoutBtnEl = $('checkout-btn'); if(checkoutBtnEl) checkoutBtnEl.addEventListener('click', checkoutWhatsApp);
  const cartCloseEl = $('cart-close'); if(cartCloseEl) cartCloseEl.addEventListener('click', closeCart);
  const cartToggleEl = $('cart-toggle'); if(cartToggleEl) cartToggleEl.addEventListener('click', toggleCart);

  // initial render
  try { cart = JSON.parse(localStorage.getItem('cart') || '[]'); } catch(err){ cart = []; }
  renderCart(); updateCartCount();
  loadCategory();

  // reduced motion respect
  if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
    document.querySelectorAll('.product-card').forEach(pc => pc.classList.add('in'));
    if(productsGrid) productsGrid.classList.add('in');
    const promo = $('aiPromo'); if(promo) promo.classList.add('in');
    const nav = document.querySelector('.navbar'); if(nav) nav.classList.add('ready');
  }

  // keep cart anim state if visible
  if (cartEl && !cartEl.classList.contains('hidden')) cartEl.classList.add('anim-in');

  // expose utility for testing
  window.__siteCurrency = {
    get: getSelectedCurrency,
    set: (v) => { setSelectedCurrency(v); renderCart(); loadCategory(); }
  };

   function initCategoryPage() {
  loadCatalog();   // your function to render the catalog
  renderCart();    // re-render cart
  updateCartCount();
}

// normal load
window.addEventListener('DOMContentLoaded', initCategoryPage);

window.addEventListener('pageshow', function(event) {
  // If page is loaded from back/forward cache, reload it
  if (event.persisted) {
    location.reload();
  }
});
   
</script>

</body>
</html>





