<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Rongtuli Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#f6f8fb;--card:#fff;--accent:#6aa8d6;--muted:#7b8794;--danger:#dc3545}
    body{font-family:Inter,system-ui,Arial;margin:0;background:var(--bg);color:#143047}
    .wrap{max-width:1100px;margin:20px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 0}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,#cde7ff,#bfe7d6);display:flex;align-items:center;justify-content:center;font-weight:700}
    .panel{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 12px 30px rgba(16,24,40,0.06)}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
    input,textarea,select{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef6;margin-top:8px}
    label{font-weight:700;font-size:13px;display:block;margin-top:10px}
    .small{font-size:13px;color:var(--muted)}
    .product-row{display:flex;gap:12px;align-items:center;padding:12px;border-radius:8px;background:#fff;margin-bottom:8px;box-shadow:0 6px 16px rgba(2,6,23,0.04)}
    .product-row img{width:84px;height:84px;object-fit:cover;border-radius:8px}
    .actions button{margin-right:6px;padding:8px 10px;border-radius:8px;border:0;cursor:pointer}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-danger {background:var(--danger);color:#fff;}
    .btn-warning{background:#f59e0b;color:#fff}
    .msg{margin-top:8px}
    /* sign-in overlay */
    .auth-overlay{position:fixed;inset:0;background:rgba(10,15,25,0.3);display:flex;align-items:center;justify-content:center;z-index:9999}
    .auth-card{width:420px;background:#fff;padding:20px;border-radius:12px;box-shadow:0 18px 40px rgba(2,6,23,0.12)}
    .auth-card h3{margin:0 0 6px 0}
    .auth-actions{display:flex;gap:8px;margin-top:12px}
    .linkish{background:transparent;border:0;color:var(--accent);cursor:pointer;text-decoration:underline;padding:0;font-weight:700}
    .hidden{display:none}
    .inline-help{font-size:13px;color:var(--muted);margin-top:8px}

    /* categories manager styling (no DB table required) */
    .categories-panel { margin-top: 12px; background:#fff;padding:12px;border-radius:12px;box-shadow:0 8px 24px rgba(2,6,23,0.04) }
    .categories-list { max-height:220px; overflow:auto; margin-top:8px; }
    .category-row { display:flex; justify-content:space-between; align-items:center; gap:8px; padding:8px; border-radius:8px; border:1px dashed rgba(0,0,0,0.03); margin-bottom:8px; }
    .category-row .count { font-weight:700; color:var(--muted); font-size:12px; margin-left:8px; }
    .category-actions button { margin-left:6px; padding:6px 8px; border-radius:6px; border:0; cursor:pointer; }
    .small-note { font-size:12px; color:var(--muted); margin-top:8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand"><div class="logo">R</div><div><div style="font-weight:800">Rongtuli Admin</div><div style="font-size:12px;color:var(--muted)">Products manager</div></div></div>
      <div>
        <button id="btn-logout" class="btn-primary hidden">Logout</button>
      </div>
    </header>

    <div class="panel" id="main-panel" style="display:none;">
      <div class="grid">
        <!-- left: product form + list -->
        <div>
          <h3>Create / Update Product</h3>
          <div class="small">Add product category, up to 3 images (min 1). You can update later.</div>

          <label>Product name</label>
          <input id="p-name" placeholder="Name" />
          
          <label>Category</label>
          <!-- category select populated from existing products + local categories -->
          <select id="p-category-select" aria-label="Choose category"></select>
          <div style="display:flex;gap:8px;margin-top:8px;">
            <input id="p-category-manual" placeholder="Or type a new category (keeps previous behavior)" />
            <button id="btn-create-category-inline" class="btn-primary" style="width:140px;">Create Category</button>
          </div>

          <label>SKU (optional)</label>
          <input id="p-sku" placeholder="SKU" />
          <label>Price (QAR)</label>
          <input id="p-price" placeholder="45.00" type="number" step="0.01" />
          <label>Stock</label>
          <input id="p-stock" placeholder="Integer" type="number" />
          <label>Description (detailed)</label>
          <textarea id="p-desc" rows="4" placeholder="Detailed description..."></textarea>

          <label>Images (1-3)</label>
          <input type="file" id="img1" accept="image/*" />
          <input type="file" id="img2" accept="image/*" />
          <input type="file" id="img3" accept="image/*" />

          <div style="display:flex;gap:8px;margin-top:12px">
            <button id="btn-create" class="btn-primary">Create Product</button>
            <button id="btn-clear">Clear</button>
          </div>
          <div id="create-msg" class="msg"></div>

          <hr style="margin:18px 0" />
          <h3>Existing Products</h3>
          <div id="products-list" style="max-height:520px;overflow:auto"></div>
        </div>

        <!-- right: quick stats / helper + categories manager -->
        <aside style="padding-left:12px">
          <div style="background:#fff;padding:12px;border-radius:12px;box-shadow:0 8px 24px rgba(2,6,23,0.04)">
            <div style="font-weight:800">Quick Actions</div>
            <div style="margin-top:8px">
              <button id="refresh-list" style="margin-right:6px" class="btn-primary">Refresh</button>
              <button id="clear-storage" class="btn-warning">Clear Cart DB</button>
            </div>
            <div style="margin-top:12px" class="small">Uploaded images are stored in your Supabase storage bucket. Product rows include the image URLs (array).</div>
          </div>

          <!-- Categories manager (client-side + product-backed updates) -->
          <div class="categories-panel">
            <div style="font-weight:800">Categories</div>
            <div style="margin-top:8px; display:flex; gap:8px;">
              <input id="new-category-name" placeholder="New category name" />
              <button id="btn-add-category" class="btn-primary">Add</button>
            </div>
            <div class="categories-list" id="categories-list">Loading categories...</div>
            <div class="small-note">Categories are derived from products' <code>category</code> values. New categories are saved locally (admin browser) until assigned to a product. Rename will update affected products in the DB. Delete will move affected products to <strong>Explore More</strong>.</div>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <!-- Sign-in overlay (shown when not authenticated) -->
  <div id="auth-overlay" class="auth-overlay" style="display:none;">
    <div class="auth-card">
      <h3>Admin sign in</h3>
      <div class="inline-help">Sign in with your admin email and password. If you don't have an account yet, use Sign up to create one.</div>

      <div style="margin-top:12px">
        <label>Email</label>
        <input id="auth-email" placeholder="you@company.com" />
        <label>Password</label>
        <input id="auth-password" type="password" placeholder="••••••••" />
      </div>

      <div class="auth-actions">
        <button id="btn-signin" class="btn-primary">Sign in</button>
        <button id="btn-signup" class="btn-warning">Sign up</button>
        <button id="btn-guest" class="linkish">Continue as guest</button>
      </div>

      <div id="auth-msg" class="msg"></div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // ---------- CONFIG (replace if needed) ----------
    const SUPABASE_URL = 'https://qhslurjvanppitwuuxtv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFoc2x1cmp2YW5wcGl0d3V1eHR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NTg0MjEsImV4cCI6MjA3NjUzNDQyMX0.8PNOewgJFDGVVIDdiEbdFE2x9Yzv29o2kdAANqaW1gA';
    const BUCKET = 'product-images';
    // -------------------------------------------------

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // elements
    const authOverlay = document.getElementById('auth-overlay');
    const authMsg = document.getElementById('auth-msg');
    const authEmail = document.getElementById('auth-email');
    const authPassword = document.getElementById('auth-password');
    const btnSignin = document.getElementById('btn-signin');
    const btnSignup = document.getElementById('btn-signup');
    const btnGuest = document.getElementById('btn-guest');

    const mainPanel = document.getElementById('main-panel');
    const btnLogout = document.getElementById('btn-logout');

    const productsList = document.getElementById('products-list');
    const createMsg = document.getElementById('create-msg');

    const categorySelect = document.getElementById('p-category-select');
    const categoryManual = document.getElementById('p-category-manual');
    const btnAddCategoryInline = document.getElementById('btn-create-category-inline');

    const categoriesListEl = document.getElementById('categories-list');
    const newCategoryNameInput = document.getElementById('new-category-name');
    const btnAddCategory = document.getElementById('btn-add-category');

    // local categories storage key
    const LS_CATS_KEY = 'rongtuli_admin_categories_v1';

    // utilities
    function showAuthOverlay(show=true){
      authOverlay.style.display = show ? 'flex' : 'none';
      mainPanel.style.display = show ? 'none' : 'block';
      btnLogout.classList.toggle('hidden', show);
    }

    // check session and show UI accordingly
    async function checkSessionAndShow() {
      const { data } = await supabase.auth.getSession();
      if (data?.session) {
        showAuthOverlay(false);
        await loadAll();
      } else {
        // show sign-in but allow guest for quick dev
        showAuthOverlay(true);
      }
    }

    // listen to auth changes (keeps UI in sync)
    supabase.auth.onAuthStateChange((event, session) => {
      if (session?.user) {
        showAuthOverlay(false);
        loadAll();
      } else {
        showAuthOverlay(true);
      }
    });

    // initial
    (async ()=>{ await checkSessionAndShow(); })();

    // sign-up
    btnSignup.addEventListener('click', async () => {
      authMsg.textContent = '';
      const email = authEmail.value.trim();
      const password = authPassword.value;
      if (!email || !password) { authMsg.style.color = 'var(--danger)'; authMsg.textContent = 'Enter email & password'; return; }
      const { data, error } = await supabase.auth.signUp({ email, password });
      if (error) { authMsg.style.color = 'var(--danger)'; authMsg.textContent = 'Signup error: ' + error.message; return; }
      authMsg.style.color = 'green';
      authMsg.textContent = 'Signup success. Check email if confirmation required. Sign in to continue.';
    });

    // sign-in
    btnSignin.addEventListener('click', async () => {
      authMsg.textContent = '';
      const email = authEmail.value.trim();
      const password = authPassword.value;
      if (!email || !password) { authMsg.style.color = 'var(--danger)'; authMsg.textContent = 'Enter email & password'; return; }
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) { authMsg.style.color = 'var(--danger)'; authMsg.textContent = 'Sign in error: ' + error.message; return; }
      // session listener will flip the UI
    });

    // guest (for testing only) - shows dashboard without logging in
    btnGuest.addEventListener('click', () => {
      // caution: guest bypass is only for quick local testing.
      // remove/hide this button in production for security.
      showAuthOverlay(false);
      loadAll();
    });

    // logout
    btnLogout.addEventListener('click', async () => {
      await supabase.auth.signOut();
      showAuthOverlay(true);
    });

    // ---------------- Category logic (DB-free) ----------------
    // Local categories are used to allow creating categories without DB table.
    // They are persisted to localStorage. Categories derived from products are authoritative for counts.

    function loadLocalCategories() {
      try {
        const raw = localStorage.getItem(LS_CATS_KEY);
        if (!raw) return [];
        return JSON.parse(raw);
      } catch (e) { return []; }
    }
    function saveLocalCategories(arr) {
      localStorage.setItem(LS_CATS_KEY, JSON.stringify(Array.from(new Set(arr.map(s => s.trim())).filter(Boolean))));
    }

    // build categories list from products + local categories
    async function buildCategoriesFromProducts() {
      // fetch all product categories
      const { data, error } = await supabase.from('products').select('category');
      if (error) {
        console.error('Could not fetch products for categories', error);
        return { categories: loadLocalCategories(), counts: {} };
      }
      const catCounts = {};
      (data || []).forEach(p => {
        const c = (p.category || '').trim();
        if (c) { catCounts[c] = (catCounts[c] || 0) + 1; }
      });
      // combine with local categories (include local categories even if count 0)
      const local = loadLocalCategories();
      const all = new Set([ ...Object.keys(catCounts), ...local ]);
      return { categories: Array.from(all).sort((a,b)=> a.localeCompare(b)), counts: catCounts };
    }

    async function loadCategoriesUI() {
      categoriesListEl.innerHTML = 'Loading categories...';
      categorySelect.innerHTML = '<option value="">Loading…</option>';
      try {
        const { categories, counts } = await buildCategoriesFromProducts();
        // render list
        if (!categories.length) {
          categoriesListEl.innerHTML = '<div class="small">No categories yet</div>';
        } else {
          categoriesListEl.innerHTML = '';
          categories.forEach(cat => {
            const row = document.createElement('div');
            row.className = 'category-row';
            row.innerHTML = `
              <div style="display:flex;align-items:center;gap:8px;">
                <div style="font-weight:800">${escapeHtml(cat)}</div>
                <div class="count">${counts[cat] ?? 0}</div>
              </div>
              <div class="category-actions">
                <button class="btn-primary rename-category" data-name="${escapeHtml(cat)}">Rename</button>
                <button class="btn-danger delete-category" data-name="${escapeHtml(cat)}">Delete</button>
              </div>
            `;
            categoriesListEl.appendChild(row);
          });
        }

        // fill select: include categories + a special create-new option
        categorySelect.innerHTML = '<option value="">— Select category —</option>';
        (categories || []).forEach(c => {
          const opt = document.createElement('option'); opt.value = c; opt.textContent = c; categorySelect.appendChild(opt);
        });
        const optCreate = document.createElement('option'); optCreate.value = '__create_new__'; optCreate.textContent = '➕ Create new category…';
        categorySelect.appendChild(optCreate);

        // attach handlers for rename / delete
        categoriesListEl.querySelectorAll('.rename-category').forEach(btn => {
          btn.addEventListener('click', async () => {
            const oldName = btn.dataset.name;
            const newName = prompt('Rename category (all products using the old name will be updated)', oldName);
            if (!newName || !newName.trim() || newName.trim() === oldName) return;
            // update products that have oldName -> newName
            const { error } = await supabase.from('products').update({ category: newName.trim() }).eq('category', oldName);
            if (error) return alert('Rename error: ' + error.message);
            // update local categories if present
            const local = loadLocalCategories();
            const updatedLocal = local.map(c => c === oldName ? newName.trim() : c);
            if (!updatedLocal.includes(newName.trim())) updatedLocal.push(newName.trim());
            saveLocalCategories(updatedLocal);
            await loadAll();
          });
        });

        categoriesListEl.querySelectorAll('.delete-category').forEach(btn => {
          btn.addEventListener('click', async () => {
            const name = btn.dataset.name;
            if (!confirm(`Delete category "${name}"?\nThis will move products using this category into "Explore More".`)) return;
            // move products to Explore More
            const { error } = await supabase.from('products').update({ category: 'Explore More' }).eq('category', name);
            if (error) return alert('Delete error: ' + error.message);
            // remove from local categories as well
            const local = loadLocalCategories().filter(c => c !== name);
            saveLocalCategories(local);
            await loadAll();
          });
        });

      } catch (err) {
        console.error(err);
        categoriesListEl.innerHTML = `<div style="color:#b91c1c">Categories load exception</div>`;
        categorySelect.innerHTML = '<option value="">— No categories —</option>';
      }
    }

    // create category: just add to local categories (persist in localStorage) so admin can assign it to products
    async function createLocalCategory(name) {
      if (!name || !name.trim()) return { error: { message: 'Name required' } };
      const local = loadLocalCategories();
      if (!local.includes(name.trim())) {
        local.push(name.trim());
        saveLocalCategories(local);
      }
      await loadCategoriesUI();
      return { ok: true };
    }

    btnAddCategory.addEventListener('click', async () => {
      const name = newCategoryNameInput.value.trim();
      if (!name) return alert('Category name required');
      const res = await createLocalCategory(name);
      if (res.error) return alert('Create category error: ' + res.error.message);
      newCategoryNameInput.value = '';
      loadCategoriesUI();
    });

    // inline 'create category' button next to the product form
    btnAddCategoryInline.addEventListener('click', async () => {
      const name = (categoryManual.value || '').trim();
      if (!name) return alert('Enter a category name first');
      const { error } = await createLocalCategory(name);
      if (error) return alert('Create category error: ' + error.message);
      categoryManual.value = '';
      loadCategoriesUI();
    });

    categorySelect.addEventListener('change', (e) => {
      if (e.target.value === '__create_new__') {
        categoryManual.focus();
      }
    });

    // ---------------- Admin product functions ----------------
    async function loadProducts(){
      productsList.innerHTML = 'Loading...';
      const { data, error } = await supabase.from('products').select('*').order('created_at',{ascending:false});
      if(error){ productsList.innerHTML = `<div style="color:#b91c1c">Failed: ${error.message}</div>`; return; }
      if(!data || data.length===0){ productsList.innerHTML = '<div class="small">No products yet</div>'; return; }

      productsList.innerHTML = '';
      data.forEach(p=>{
        const item = document.createElement('div');
        item.className = 'product-row';
        const img = (p.image_urls && p.image_urls[0]) ? `<img src="${p.image_urls[0]}" />` : `<div style="width:84px;height:84px;border-radius:8px;background:#f1f6fb"></div>`;
        item.innerHTML = `
          ${img}
          <div style="flex:1">
            <div style="font-weight:800">${escapeHtml(p.name)}</div>
            <div class="small">${escapeHtml(p.category||'Uncategorized')} • ${escapeHtml(p.sku||'')}</div>
            <div style="margin-top:6px">${escapeHtml(p.description? (p.description.slice(0,140)) : '')}</div>
            <div style="margin-top:6px;font-weight:800">QAR ${p.price || 0} • Stock: <input data-id="${p.id}" class="stock-input" value="${p.stock || 0}" style="width:80px" /></div>
          </div>
          <div class="actions">
            <button class="btn-primary save-stock" data-id="${p.id}">Save</button>
            <button class="btn-warning edit-prod" data-id="${p.id}">Edit</button>
            <button class="btn-danger delete-prod" data-id="${p.id}">Delete</button>
          </div>
        `;
        productsList.appendChild(item);
      });

      // attach handlers
      productsList.querySelectorAll('.save-stock').forEach(b=>{
        b.addEventListener('click', async ()=> {
          const id = +b.dataset.id;
          const input = document.querySelector(`.stock-input[data-id="${id}"]`);
          const val = parseInt(input.value) || 0;
          const { error } = await supabase.from('products').update({stock: val}).eq('id', id);
          if(error) alert('Error: '+error.message); else { alert('Stock updated'); loadProducts(); }
        });
      });

      productsList.querySelectorAll('.delete-prod').forEach(b=>{
        b.addEventListener('click', async ()=> {
          if(!confirm('Delete product?')) return;
          const id = +b.dataset.id;
          const { error } = await supabase.from('products').delete().eq('id', id);
          if(error) alert('Delete error: '+error.message); else { alert('Deleted'); loadProducts(); loadCategoriesUI(); }
        });
      });

      productsList.querySelectorAll('.edit-prod').forEach(b=>{
        b.addEventListener('click', async ()=> {
          const id = +b.dataset.id;
          const { data } = await supabase.from('products').select('*').eq('id', id).single();
          if(!data) return alert('Not found');

          // nicer edit flow with category choice
          const newName = prompt('Name', data.name) || data.name;

          // build category suggestions
          const { categories } = await buildCategoriesFromProducts();
          let newCategory = data.category || '';
          if (categories.length) {
            const choice = prompt(`Category (type new or choose one):\n${categories.join(', ')}`, data.category || categories[0] || '');
            if (choice !== null) newCategory = choice;
          } else {
            newCategory = prompt('Category', data.category || '') || data.category;
          }

          const newPrice = parseFloat(prompt('Price', data.price) || data.price) || 0;
          const newDesc = prompt('Description', data.description || '') || data.description;
          const { error } = await supabase.from('products').update({ name:newName, category:newCategory, price:newPrice, description:newDesc }).eq('id', id);
          if(error) alert('Update error: '+error.message); else { alert('Updated'); loadProducts(); loadCategoriesUI(); }
        });
      });
    }

    // create product - supports up to 3 images (min 1)
    document.getElementById('btn-create').addEventListener('click', async ()=>{
      createMsg.textContent=''; createMsg.style.color='';
      const name = document.getElementById('p-name').value.trim();
      // choose category: prefer selected category, else manual input
      let category = '';
      const sel = (categorySelect.value || '').trim();
      if (sel && sel !== '__create_new__') category = sel;
      const manual = document.getElementById('p-category-manual').value.trim();
      if (manual) category = manual;
      const sku = document.getElementById('p-sku').value.trim();
      const price = parseFloat(document.getElementById('p-price').value) || 0;
      const stock = parseInt(document.getElementById('p-stock').value) || 0;
      const desc = document.getElementById('p-desc').value.trim();
      if(!name){ createMsg.style.color='var(--danger)'; createMsg.textContent = 'Name required'; return; }

      const files = [document.getElementById('img1').files[0], document.getElementById('img2').files[0], document.getElementById('img3').files[0]].filter(Boolean);
      if(files.length === 0){ createMsg.style.color='var(--danger)'; createMsg.textContent = 'Please upload at least 1 image'; return; }

      // upload files
      const urls = [];
      for (const f of files){
        try {
          const filename = `${Date.now()}_${f.name.replace(/\s+/g,'_')}`;
          const { data: up, error: upErr } = await supabase.storage.from(BUCKET).upload(filename, f, { cacheControl:'3600', upsert:false });
          if(upErr){ createMsg.style.color='var(--danger)'; createMsg.textContent = 'Upload error: '+upErr.message; return; }
          const { data: urlData } = supabase.storage.from(BUCKET).getPublicUrl(filename);
          const publicUrl = urlData?.publicUrl || urlData?.publicURL || '';
          urls.push(publicUrl);
        } catch(err) {
          createMsg.style.color='var(--danger)'; createMsg.textContent = 'Upload exception: '+err.message; return;
        }
      }

      // insert product
      const { data, error } = await supabase.from('products').insert([{ name, category, sku, price, stock, description: desc, image_urls: urls }]);
      if(error){ createMsg.style.color='var(--danger)'; createMsg.textContent = 'DB insert error: '+error.message; return; }
      createMsg.style.color='green'; createMsg.textContent = 'Created';
      // clear
      ['p-name','p-category-manual','p-sku','p-price','p-stock','p-desc','img1','img2','img3'].forEach(id => { const el = document.getElementById(id); if(el) el.value=''; });
      // refresh
      loadProducts();
      loadCategoriesUI(); // update counts & select
    });

    document.getElementById('btn-clear').addEventListener('click', ()=>{ ['p-name','p-category-manual','p-sku','p-price','p-stock','p-desc','img1','img2','img3'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; }); createMsg.textContent=''; });

    document.getElementById('refresh-list').addEventListener('click', async ()=>{ await loadCategoriesUI(); await loadProducts(); });
    document.getElementById('clear-storage').addEventListener('click', ()=>{ if(confirm('Clear local cart storage?')){ localStorage.removeItem('rongtuli_cart'); alert('Cleared'); }});

    document.getElementById('btn-logout').addEventListener('click', async ()=>{ await supabase.auth.signOut(); showAuthOverlay(true); });

    // helper: load both categories + products
    async function loadAll() {
      await loadCategoriesUI();
      await loadProducts();
    }

    // helpers
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"'`=\/]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#x60;','/':'&#x2F;'}[c])); }
    function slugify(s){ return s.toLowerCase().replace(/[^\w\s-]/g,'').trim().replace(/\s+/g,'-'); }

  </script>
</body>
</html>
