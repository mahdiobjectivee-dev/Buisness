<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Rongtuli Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#f6f8fb; --card:#fff; --accent:#6aa8d6; --muted:#7092b0; --muted-2:#7b8794; --danger:#dc3545;
      --radius:12px; --shadow:0 12px 30px rgba(16,24,40,0.06);
    }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Arial;margin:0;background:var(--bg);color:#143047;padding:18px}
    .container{max-width:1200px;margin:0 auto;display:flex;flex-direction:column;gap:18px}
    /* Top center logo */
    .top-logo{display:flex;justify-content:center;align-items:center;margin-top:4px}
    .top-logo img{max-height:90px;width:auto}
    /* Form card */
    .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:var(--shadow)}
    .form-row{display:flex;gap:12px;flex-wrap:wrap}
    input,textarea,select{padding:10px;border-radius:10px;border:1px solid #eef6fb;background:#fff;font-size:14px}
    input[type="file"]{padding:6px}
    label{font-weight:700;margin-top:10px;display:block}
    .muted{color:var(--muted-2);font-size:13px}
    .btn{padding:10px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:800}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-ghost{background:#fff;border:1px solid #eef6fb;color:#143047}
    .grid{display:grid;grid-template-columns:1fr 320px;gap:18px;align-items:start}
    @media(max-width:980px){ .grid{grid-template-columns:1fr} .sidebar{order:2} .main{order:1} }

    /* category blocks */
    .category-block{margin-top:12px}
    .category-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .category-title{font-weight:900;font-size:16px}
    .category-meta{color:var(--muted-2);font-weight:700}
    .category-actions{display:flex;gap:8px;align-items:center}

    .products-row{display:flex;gap:12px;flex-wrap:wrap}
    .product-card{width:220px;background:#fff;border-radius:10px;padding:10px;box-shadow:0 8px 24px rgba(2,6,23,0.04);display:flex;flex-direction:column;gap:8px}
    .product-card img{width:100%;height:130px;object-fit:cover;border-radius:8px}
    .product-card .name{font-weight:800;color:var(--muted)}
    .product-card .meta{font-size:13px;color:#6b7280}
    .product-actions{display:flex;gap:6px;margin-top:auto}

    /* see all link */
    .see-all{background:transparent;border:0;color:var(--accent);cursor:pointer;font-weight:800}

    /* create category area at end */
    .create-category{margin-top:16px;display:flex;gap:8px;align-items:center}

    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:12000}
    .modal{background:var(--card);padding:16px;border-radius:12px;width:800px;max-width:96%;box-shadow:0 30px 80px rgba(2,6,23,0.3)}
    .modal .thumbs{display:flex;gap:8px;flex-wrap:wrap}
    .thumbs img{width:72px;height:72px;object-fit:cover;border-radius:8px}

    /* login overlay (unchanged look & behavior) */
    .auth-overlay{position:fixed;inset:0;background:#f6f8fb;display:flex;align-items:center;justify-content:center;z-index:14000}
    .auth-wrapper{width:780px;max-width:94%;background:var(--card);border-radius:14px;box-shadow:0 30px 80px rgba(2,6,23,0.08);display:flex;gap:24px;overflow:hidden}
    .auth-left{width:320px;padding:28px;display:flex;align-items:center;justify-content:center;border-right:1px solid #eef6fb}
    .auth-left img{max-width:100%;height:auto}
    .auth-right{flex:1;padding:28px 36px;display:flex;flex-direction:column;justify-content:center}
    .auth-title{font-size:20px;font-weight:800;color:#143047;margin-bottom:6px}
    .auth-desc{color:var(--muted-2);margin-bottom:18px;font-size:13px}
    .auth-right input{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #eef6fb;background:#fff}
    .login-btn{margin-top:12px;padding:12px 16px;background:var(--accent);color:#fff;border:0;font-weight:800;border-radius:10px;cursor:pointer}
    .secondary{margin-top:8px;background:transparent;border:1px solid #eef6fb;color:#143047;padding:10px;border-radius:10px;cursor:pointer}
    .help{margin-top:10px;color:var(--muted-2);font-size:13px}

    /* search input style */
    .search-row{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    .search-row input{flex:1;padding:10px;border-radius:10px;border:1px solid #e6eef7}
    .search-count{font-weight:700;color:var(--muted-2);margin-left:8px}

    footer{margin-top:22px;text-align:center;color:var(--muted-2)}
  </style>
</head>
<body>
  <!-- AUTH overlay (unchanged) -->
  <div id="auth-overlay" class="auth-overlay" aria-hidden="false">
    <div class="auth-wrapper" role="dialog" aria-modal="true" aria-labelledby="authTitle">
      <div class="auth-left">
        <!-- place your logo image at assets/admin-login.png or update path -->
        <img src="assets/logo1.png" alt="Rongtuli logo (place image here)" onerror="this.style.display='none'">
      </div>
      <div class="auth-right">
        <div class="auth-title" id="authTitle">ADMIN PANEL</div>
        <div class="auth-desc">Sign in with your admin credentials to manage products</div>

        <input id="auth-email" placeholder="Enter Your Email" type="email" />
        <input id="auth-password" type="password" placeholder="Enter Your Password" />
        <button id="btn-signin" class="login-btn">Login</button>
        <button id="btn-guest" class="secondary" style="display:none">Continue as guest</button>

        <div class="help auth-help" style="display:flex;justify-content:space-between;align-items:center">
          <div class="help-left">
            <div class="help">Need help? contact the owner to create an account</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- APP root (hidden until logged in) -->
  <div id="appRoot" style="display:none">
    <div class="container">

      <!-- Top centered logo -->
      <div class="top-logo">
        <img id="topLogo" src="assets/logo.png" alt="Rongtuli (place logo here)" onerror="this.style.display='none'">
      </div>

       <!-- put this inside the sidebar card, e.g. under Quick actions -->
      <button id="btn-logout" class="btn btn-ghost" style="margin-top:12px;background-color: #7092b059;">Logout</button>

      <!-- CREATE PRODUCT FORM: shown first -->
      <div class="card" style="width:100%">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:900;font-size:18px">Create / Upload Product</div>
          <div class="muted">Quick add a product — images stored in your storage bucket</div>
        </div>

        <div style="margin-top:12px" id="createForm">
          <label>Product name</label>
          <input id="p-name" placeholder="Name" />

          <label>Category</label>
          <select id="p-category-select" aria-label="Choose category"></select>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="p-category-manual" placeholder="Or type a new category" />
            <button id="btn-create-category-inline" class="btn btn-primary">Create</button>
          </div>

          <label style="margin-top:10px">SKU (optional)</label>
          <input id="p-sku" placeholder="SKU" />

          <div style="display:flex;gap:12px;margin-top:8px;flex-wrap:wrap">
            <div style="flex:1;min-width:160px">
              <label>Price (QAR)</label>
              <input id="p-price" placeholder="45.00" type="number" step="0.01" />
            </div>
            <div style="min-width:140px">
              <label>Stock</label>
              <input id="p-stock" placeholder="Integer" type="number" />
            </div>
          </div>

          <label>Description</label>
          <textarea id="p-desc" placeholder="Detailed description..."></textarea>

          <label>Images (1-3)</label>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <input type="file" id="img1" accept="image/*" />
            <input type="file" id="img2" accept="image/*" />
            <input type="file" id="img3" accept="image/*" />
          </div>

          <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
            <button id="btn-create" class="btn btn-primary">Create product</button>
            <button id="btn-clear" class="btn btn-ghost">Clear</button>
            <div id="create-msg" class="muted" style="margin-left:auto"></div>
          </div>
        </div>
      </div>

     


      <!-- Main grid: left is categories & products, right is sidebar -->
      <div class="grid">
        <div class="main">
          <!-- SEARCH -->
          <div class="card" style="margin-bottom:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:900">Search products</div>
              <div class="muted">Search by name, SKU, category or description</div>
            </div>
            <div class="search-row" style="margin-top:10px">
              <input id="adminSearch" placeholder="Type to search (press Enter to run)..." />
              <button id="adminSearchClear" class="btn btn-ghost">Clear</button>
              <div id="searchCount" class="search-count"></div>
            </div>
          </div>

          <div id="categories-container">
            <!-- categories and products will be injected here -->
            <div class="muted">Loading categories & products…</div>
          </div>

          <!-- after categories: create category area -->
          <div class="card" style="margin-top:12px">
            <div style="display:flex;align-items:center;justify-content:space-between">
              <div style="font-weight:900">Create a new category</div>
              <div class="muted">Creates a local category that can be assigned to products</div>
            </div>
            <div class="create-category" style="margin-top:10px">
              <input id="new-category-name" placeholder="Category name" />
              <button id="btn-add-category" class="btn btn-primary">Add category</button>
            </div>
          </div>
        </div>

        <aside class="sidebar card">
          <div style="font-weight:900;margin-bottom:8px">Quick actions</div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <button id="refresh-list" class="btn btn-primary">Refresh</button>
            <button id="btn-export" class="btn btn-ghost">Export CSV</button>
            <button id="btn-import" class="btn btn-ghost">Import CSV</button>
          </div>

          <div style="margin-top:14px">
            <div style="font-weight:900">Categories</div>
            <div id="categories-list-sidebar" style="margin-top:8px" class="muted">Loading…</div>
          </div>

          <div style="margin-top:12px" class="muted">Tip: Click Rename on a category to rename it for all products. Delete moves products to "Explore More".</div>
        </aside>
      </div>

      <footer>© <span id="year"></span> Rongtuli</footer>
    </div>
  </div>

  <!-- Edit modal -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 id="modalTitle">Edit product</h3>
        <div>
          <button id="modalClose" class="btn btn-ghost">Close</button>
        </div>
      </div>

      <div style="display:flex;gap:12px;margin-top:12px">
        <div style="flex:1">
          <label>Name</label>
          <input id="edit-name" />

          <label>Category</label>
          <select id="edit-category-select"></select>

          <label>SKU</label>
          <input id="edit-sku" />

          <label>Price (QAR)</label>
          <input id="edit-price" type="number" step="0.01" />

          <label>Stock</label>
          <input id="edit-stock" type="number" />

          <label>Description</label>
          <textarea id="edit-desc"></textarea>

          <div style="display:flex;gap:8px;margin-top:12px">
            <button id="btn-save-edit" class="btn btn-primary">Save changes</button>
            <button id="btn-cancel-edit" class="btn btn-ghost">Cancel</button>
            <div id="edit-msg" class="muted" style="margin-left:auto"></div>
          </div>
        </div>

        <div style="width:260px">
          <div style="font-weight:800">Images</div>
          <div id="edit-thumbs" class="thumbs" style="margin-top:8px"></div>

          <label style="margin-top:12px">Replace / Add</label>
          <input id="edit-img1" type="file" accept="image/*" />
          <input id="edit-img2" type="file" accept="image/*" />
          <input id="edit-img3" type="file" accept="image/*" />
          <div class="muted" style="margin-top:10px">If you upload new images they will replace current images.</div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // your supabase config (unchanged)
   const SUPABASE_URL = 'https://qhslurjvanppitwuuxtv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFoc2x1cmp2YW5wcGl0d3V1eHR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NTg0MjEsImV4cCI6MjA3NjUzNDQyMX0.8PNOewgJFDGVVIDdiEbdFE2x9Yzv29o2kdAANqaW1gA';
   
   
    const BUCKET = 'product-images';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // DOM
    const authOverlay = document.getElementById('auth-overlay');
    const appRoot = document.getElementById('appRoot');
    const btnSignin = document.getElementById('btn-signin');
    const authEmail = document.getElementById('auth-email');
    const authPassword = document.getElementById('auth-password');
    const btnLogout = document.getElementById('btn-logout'); // visible in UI
    const btnGuest = document.getElementById('btn-guest');
    document.getElementById('year').textContent = new Date().getFullYear();

    // create form
    const categorySelect = document.getElementById('p-category-select');
    const categoryManual = document.getElementById('p-category-manual');
    const btnCreateLocalCat = document.getElementById('btn-create-category-inline');
    const btnCreate = document.getElementById('btn-create');
    const btnClear = document.getElementById('btn-clear');
    const createMsg = document.getElementById('create-msg');

    // categories & lists
    const categoriesContainer = document.getElementById('categories-container');
    const categoriesListSidebar = document.getElementById('categories-list-sidebar');
    const btnAddCategory = document.getElementById('btn-add-category');
    const newCategoryNameInput = document.getElementById('new-category-name');

    const btnRefresh = document.getElementById('refresh-list');

    // modal
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalClose = document.getElementById('modalClose');
    const btnSaveEdit = document.getElementById('btn-save-edit');
    const btnCancelEdit = document.getElementById('btn-cancel-edit');
    const editMsg = document.getElementById('edit-msg');
    const editName = document.getElementById('edit-name');
    const editCategorySelect = document.getElementById('edit-category-select');
    const editSku = document.getElementById('edit-sku');
    const editPrice = document.getElementById('edit-price');
    const editStock = document.getElementById('edit-stock');
    const editDesc = document.getElementById('edit-desc');
    const editThumbs = document.getElementById('edit-thumbs');
    const editImg1 = document.getElementById('edit-img1');
    const editImg2 = document.getElementById('edit-img2');
    const editImg3 = document.getElementById('edit-img3');

    // search elements
    const adminSearch = document.getElementById('adminSearch');
    const adminSearchClear = document.getElementById('adminSearchClear');
    const searchCount = document.getElementById('searchCount');

    const LS_CATS_KEY = 'rongtuli_admin_categories_v1';
    let currentEdit = null;
    let allProducts = null; // cached copy of products
    let currentSearchQuery = ''; // current search term

    // helpers
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"'`=\/]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#x60;','/':'&#x2F;'}[c])); }
    function toast(t){ const el = document.createElement('div'); el.textContent=t; Object.assign(el.style,{position:'fixed',bottom:'20px',left:'50%',transform:'translateX(-50%)',background:'#143047',color:'#fff',padding:'8px 12px',borderRadius:'8px',zIndex:15000}); document.body.appendChild(el); setTimeout(()=>el.remove(),1600); }

    // debounce helper
    function debounce(fn, wait=220){
      let t;
      return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); };
    }

    // auth flow (show overlay until signed in)
    async function checkSession(){
      const { data } = await supabase.auth.getSession();
      if(data?.session){
        authOverlay.style.display='none';
        appRoot.style.display='block';
        await loadAll();
      } else {
        authOverlay.style.display='flex';
        appRoot.style.display='none';
      }
    }
    supabase.auth.onAuthStateChange((e, session) => {
      if(session?.user){ authOverlay.style.display='none'; appRoot.style.display='block'; loadAll(); }
      else { authOverlay.style.display='flex'; appRoot.style.display='none'; }
    });
    (async ()=>{ await checkSession(); })();

    btnSignin.addEventListener('click', async ()=>{
      const email = (authEmail.value||'').trim();
      const pw = authPassword.value;
      if(!email || !pw) return toast('Enter email & password');
      const { error } = await supabase.auth.signInWithPassword({ email, password: pw });
      if(error) return toast('Sign in error: '+error.message);
      toast('Signed in');
    });

    // LOGOUT handler (new) — signs out and resets UI/cache
    btnLogout.addEventListener('click', async () => {
      try {
        await supabase.auth.signOut();
      } catch (err) {
        // signOut might throw for network reasons; still try to clear UI
        console.warn('signOut error', err);
      }
      // Reset client-side state and show login overlay
      allProducts = null;
      currentSearchQuery = '';
      adminSearch.value = '';
      searchCount.textContent = '';
      authOverlay.style.display = 'flex';
      appRoot.style.display = 'none';
      toast('Signed out');
    });

    // categories local storage helpers
    function loadLocalCategories(){ try{ return JSON.parse(localStorage.getItem(LS_CATS_KEY)||'[]'); }catch(e){return[]} }
    function saveLocalCategories(arr){ localStorage.setItem(LS_CATS_KEY, JSON.stringify(Array.from(new Set(arr.map(s=>s.trim()).filter(Boolean))))); }

    // fetch & cache all products
    async function fetchAllProducts(){
      const { data, error } = await supabase.from('products').select('*').order('created_at',{ascending:false});
      if(error){ throw error; }
      allProducts = data || [];
      return allProducts;
    }

    // build categories from products + local
    async function buildCategoriesFromProducts(){
      // ensure allProducts is loaded
      if(!allProducts) await fetchAllProducts();
      const counts = {};
      (allProducts || []).forEach(p => {
        const c = (p.category || '').trim();
        if(c) counts[c] = (counts[c] || 0) + 1;
      });
      const local = loadLocalCategories();
      const all = new Set([ ...Object.keys(counts), ...local ]);
      return { categories: Array.from(all).sort((a,b)=>a.localeCompare(b)), counts };
    }

    // filter helper
    function matchesQuery(p, q){
      if(!q) return true;
      q = q.trim().toLowerCase();
      const fields = [p.name || '', p.description || '', p.category || '', p.sku || ''].join(' ');
      return fields.toLowerCase().indexOf(q) !== -1;
    }

    // render categories & products grouped view
    // shows up to previewLimit items per category; "See all" toggles full view in-place
    async function renderCategoriesView(previewLimit = 4, searchQuery = ''){
      categoriesContainer.innerHTML = '';
      categoriesContainer.appendChild(document.createElement('div')).textContent = 'Loading…';

      try {
        // ensure we have cached products
        if(!allProducts) await fetchAllProducts();
      } catch(err){
        categoriesContainer.innerHTML = `<div style="color:#b91c1c">Error loading products: ${err.message}</div>`;
        return;
      }

      // apply search to produce filtered product list
      const filteredProducts = (allProducts || []).filter(p => matchesQuery(p, searchQuery));

      // compute category list from filtered products + local categories (ensures creation UI still shows local cats)
      const counts = {};
      filteredProducts.forEach(p => {
        const c = (p.category || '').trim();
        if(c) counts[c] = (counts[c] || 0) + 1;
      });
      const local = loadLocalCategories();
      const allCatsSet = new Set([ ...Object.keys(counts), ...local ]);
      const categories = Array.from(allCatsSet).sort((a,b)=>a.localeCompare(b));

      categoriesContainer.innerHTML = '';

      // show search title if searching
      if(searchQuery){
        const searchHeader = document.createElement('div');
        searchHeader.className = 'card';
        searchHeader.style.marginBottom = '12px';
        searchHeader.innerHTML = `<div style="font-weight:900">Search results for "<em>${escapeHtml(searchQuery)}</em>"</div>
                                  <div class="muted" style="margin-top:6px">${filteredProducts.length} items found</div>`;
        categoriesContainer.appendChild(searchHeader);
        searchCount.textContent = `${filteredProducts.length} results`;
      } else {
        searchCount.textContent = '';
      }

      // for each category create block, but only if category has items (when searching we skip zero-count categories)
      for(const cat of categories){
        const catCount = counts[cat] || 0;
        if(searchQuery && catCount === 0) continue; // skip empty categories during search

        const catBlock = document.createElement('div'); catBlock.className = 'category-block card';
        const header = document.createElement('div'); header.className = 'category-header';
        const left = document.createElement('div'); left.innerHTML = `<div class="category-title">${escapeHtml(cat)}</div><div class="category-meta">${catCount||0} items</div>`;
        const right = document.createElement('div'); right.className = 'category-actions';

        // rename button
        const renameBtn = document.createElement('button'); renameBtn.className='btn btn-ghost'; renameBtn.textContent='Rename';
        renameBtn.addEventListener('click', async ()=>{
          const newName = prompt('Rename category (updates all products using it)', cat);
          if(!newName || !newName.trim() || newName.trim()===cat) return;
          const { error } = await supabase.from('products').update({ category: newName.trim() }).eq('category', cat);
          if(error) return toast('Rename failed: '+error.message);
          // update local category list
          const localCats = loadLocalCategories().map(c=> c===cat ? newName.trim() : c);
          if(!localCats.includes(newName.trim())) localCats.push(newName.trim());
          saveLocalCategories(localCats);
          await reloadAll(); // refresh cache + UI
          toast('Category renamed');
        });

        // delete button
        const delBtn = document.createElement('button'); delBtn.className='btn btn-ghost'; delBtn.textContent='Delete';
       delBtn.addEventListener('click', async ()=> {
  if(!confirm(`Delete category "${cat}" and ALL products in it permanently (including images)? This cannot be undone.`)) return;

  try {
    // fetch the products to delete so we can remove images
    const { data: productsToDelete, error: fetchErr } = await supabase
      .from('products').select('id, image_urls').eq('category', cat);
    if (fetchErr) throw fetchErr;

    // collect filenames from public URLs (adjust selector if your URLs are structured differently)
    const toRemove = [];
    productsToDelete.forEach(p => {
      (p.image_urls || []).forEach(url => {
        try {
          const parts = url.split('/');
          const filename = decodeURIComponent(parts[parts.length - 1].split('?')[0] || '');
          if (filename) toRemove.push(filename);
        } catch(e) { /* ignore parse errors */ }
      });
    });

    // remove files from storage (if any)
    if (toRemove.length) {
      const { error: rmErr } = await supabase.storage.from(BUCKET).remove(toRemove);
      if (rmErr) console.warn('Storage removal error (continuing):', rmErr);
    }

    // now delete products rows
    const { error: delErr } = await supabase.from('products').delete().eq('category', cat);
    if (delErr) throw delErr;

    // update local categories and UI
    saveLocalCategories(loadLocalCategories().filter(c => c !== cat));
    await reloadAll();
    toast('Category, products and images deleted');
  } catch (err) {
    toast('Delete failed: ' + (err.message || err));
    console.error(err);
  }
});

        right.appendChild(renameBtn);
        right.appendChild(delBtn);
        header.appendChild(left); header.appendChild(right);
        catBlock.appendChild(header);

        // get products for this category (from full product list, then filter)
        const items = filteredProducts.filter(p => (p.category||'').trim() === cat);
        const productsRow = document.createElement('div'); productsRow.className = 'products-row';
        const showCount = Math.min(previewLimit, items.length);

        // create product cards (preview)
        for(let i=0;i<showCount;i++){
          const p = items[i];
          const card = makeProductCard(p);
          productsRow.appendChild(card);
        }
        catBlock.appendChild(productsRow);

        // if more than previewLimit show See all button
        if(items.length > previewLimit){
          const seeAllBtn = document.createElement('button'); seeAllBtn.className='see-all'; seeAllBtn.textContent = `See all (${items.length})`;
          let expanded = false;
          seeAllBtn.addEventListener('click', ()=>{
            expanded = !expanded;
            if(expanded){
              // append remaining product cards
              for(let i=previewLimit;i<items.length;i++){
                productsRow.appendChild(makeProductCard(items[i]));
              }
              seeAllBtn.textContent = 'Show less';
            } else {
              // collapse back to previewLimit
              while(productsRow.children.length > previewLimit) productsRow.removeChild(productsRow.lastChild);
              seeAllBtn.textContent = `See all (${items.length})`;
              window.scrollTo({top: catBlock.offsetTop - 80, behavior: 'smooth'});
            }
          });
          catBlock.appendChild(seeAllBtn);
        }

        categoriesContainer.appendChild(catBlock);
      }

      // if there are no categories or no results
      if(categories.length === 0 || (searchQuery && filteredProducts.length === 0)){
        const no = document.createElement('div'); no.className='card';
        no.innerHTML = `<div class="muted">${ searchQuery ? `No results for "${escapeHtml(searchQuery)}"` : 'No categories yet. Create one below.'}</div>`;
        categoriesContainer.appendChild(no);
      }

      // final: update sidebar list & selects
      categoriesListSidebar.innerHTML = '';
      const { categories: catList, counts: globalCounts } = await buildCategoriesFromProducts();
      for(const c of catList){
        const el = document.createElement('div'); el.className='muted'; el.style.marginBottom='6px';
        el.innerHTML = `<strong>${escapeHtml(c)}</strong><span style="float:right">${globalCounts[c]||0}</span>`;
        categoriesListSidebar.appendChild(el);
      }

      // repopulate category selects (full set — not filtered)
      editCategorySelect.innerHTML = '<option value="">— Select category —</option>';
      categorySelect.innerHTML = '<option value="">— Select category —</option>';
      for(const c of catList){
        const opt = document.createElement('option'); opt.value=c; opt.textContent=c;
        categorySelect.appendChild(opt);
        editCategorySelect.appendChild(opt.cloneNode(true));
      }
      const createNewOpt = document.createElement('option'); createNewOpt.value='__create_new__'; createNewOpt.textContent='➕ Create new…';
      categorySelect.appendChild(createNewOpt);
      editCategorySelect.appendChild(createNewOpt.cloneNode(true));
    }

    // helper to build product card DOM element
    function makeProductCard(p){
      const card = document.createElement('div'); card.className='product-card';
      const img = document.createElement('img'); img.src = (p.image_urls && p.image_urls[0]) ? p.image_urls[0] : 'https://via.placeholder.com/300x200?text=No+Image';
      img.alt = p.name || 'product';
      card.appendChild(img);
      const name = document.createElement('div'); name.className='name'; name.textContent = p.name || 'Product';
      card.appendChild(name);
      const meta = document.createElement('div'); meta.className='meta'; meta.textContent = `${p.category || 'Uncategorized'} • QAR ${Number(p.price||0).toFixed(2)}`;
      card.appendChild(meta);
      const desc = document.createElement('div'); desc.className='muted'; desc.style.fontSize='13px'; desc.textContent = (p.description||'').slice(0,80);
      card.appendChild(desc);

      const actions = document.createElement('div'); actions.className='product-actions';
      const editBtn = document.createElement('button'); editBtn.className='btn btn-ghost'; editBtn.textContent='Edit';
      editBtn.addEventListener('click', ()=> openEditModal(p));
      const delBtn = document.createElement('button'); delBtn.className='btn btn-ghost'; delBtn.textContent='Delete';
      delBtn.addEventListener('click', async ()=>{
        if(!confirm('Delete product?')) return;
        const { error } = await supabase.from('products').delete().eq('id', p.id);
        if(error) return toast('Delete failed: '+error.message);
        toast('Deleted');
        await reloadAll(); // refresh cache + UI with current search preserved
      });
      actions.appendChild(editBtn); actions.appendChild(delBtn);
      card.appendChild(actions);
      return card;
    }

    // open edit modal (fills fields)
    function openEditModal(product){
      currentEdit = product;
      editMsg.textContent = '';
      editName.value = product.name || '';
      editSku.value = product.sku || '';
      editPrice.value = Number(product.price || 0);
      editStock.value = Number(product.stock || 0);
      editDesc.value = product.description || '';
      editThumbs.innerHTML = '';
      (product.image_urls || []).forEach(u => { const im = document.createElement('img'); im.src=u; editThumbs.appendChild(im); });
      setTimeout(()=> { try{ editCategorySelect.value = product.category || ''; } catch(e) {} },50);
      modalBackdrop.style.display = 'flex';
    }

    // modal handlers
    modalClose.addEventListener('click', ()=> { modalBackdrop.style.display='none'; currentEdit=null; });
    btnCancelEdit.addEventListener('click', ()=> { modalBackdrop.style.display='none'; currentEdit=null; });

    btnSaveEdit.addEventListener('click', async ()=>{
      if(!currentEdit) return;
      const id = currentEdit.id;
      const name = (editName.value||'').trim();
      let category = (editCategorySelect.value||'').trim();
      if(category === '__create_new__') category = '';
      const sku = (editSku.value||'').trim();
      const price = parseFloat(editPrice.value) || 0;
      const stock = parseInt(editStock.value) || 0;
      const desc = (editDesc.value||'').trim();

      const newFiles = [editImg1.files[0], editImg2.files[0], editImg3.files[0]].filter(Boolean);
      let finalUrls = currentEdit.image_urls || [];

      if(newFiles.length){
        editMsg.textContent = 'Uploading images...';
        finalUrls = [];
        for(const f of newFiles){
          try {
            const filename = `${Date.now()}_${f.name.replace(/\s+/g,'_')}`;
            const { data: up, error: upErr } = await supabase.storage.from(BUCKET).upload(filename, f, { cacheControl:'3600', upsert:false });
            if(upErr){ editMsg.textContent = 'Upload error'; return; }
            const { data: urlData } = supabase.storage.from(BUCKET).getPublicUrl(filename);
            finalUrls.push(urlData?.publicUrl || urlData?.publicURL || '');
          } catch(e){ editMsg.textContent = 'Upload exception'; return; }
        }
      }

      editMsg.textContent = 'Saving...';
      const { error } = await supabase.from('products').update({ name, category, sku, price, stock, description: desc, image_urls: finalUrls }).eq('id', id);
      if(error){ editMsg.textContent = 'Save failed'; return; }
      editMsg.textContent = 'Saved';
      modalBackdrop.style.display = 'none';
      currentEdit = null;
      await reloadAll();
      toast('Product updated');
    });

    // create product flow
    btnCreate.addEventListener('click', async ()=>{
      createMsg.textContent=''; createMsg.style.color='';
      const name = (document.getElementById('p-name').value||'').trim();
      let category = (categorySelect.value||'').trim(); if(category === '__create_new__') category='';
      const manual = (categoryManual.value||'').trim(); if(manual) category = manual;
      const sku = (document.getElementById('p-sku').value||'').trim();
      const price = parseFloat(document.getElementById('p-price').value) || 0;
      const stock = parseInt(document.getElementById('p-stock').value) || 0;
      const desc = (document.getElementById('p-desc').value||'').trim();
      if(!name){ createMsg.textContent='Name required'; createMsg.style.color='var(--danger)'; return; }

      const files = [document.getElementById('img1').files[0], document.getElementById('img2').files[0], document.getElementById('img3').files[0]].filter(Boolean);
      if(files.length === 0){ createMsg.textContent='Upload at least 1 image'; createMsg.style.color='var(--danger)'; return; }

      createMsg.textContent = 'Uploading...';
      const urls = [];
      for(const f of files){
        try {
          const filename = `${Date.now()}_${f.name.replace(/\s+/g,'_')}`;
          const { data: up, error: upErr } = await supabase.storage.from(BUCKET).upload(filename, f, { cacheControl:'3600', upsert:false });
          if(upErr){ createMsg.textContent = 'Upload error: '+upErr.message; createMsg.style.color='var(--danger)'; return; }
          const { data: urlData } = supabase.storage.from(BUCKET).getPublicUrl(filename);
          urls.push(urlData?.publicUrl || urlData?.publicURL || '');
        } catch(e){ createMsg.textContent='Upload exception'; createMsg.style.color='var(--danger)'; return; }
      }

      createMsg.textContent = 'Saving...';
      const { data, error } = await supabase.from('products').insert([{ name, category, sku, price, stock, description: desc, image_urls: urls }]);
      if(error){ createMsg.textContent='DB error: '+error.message; createMsg.style.color='var(--danger)'; return; }
      createMsg.textContent='Created'; createMsg.style.color='var(--accent)';
      ['p-name','p-category-manual','p-sku','p-price','p-stock','p-desc','img1','img2','img3'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
      await reloadAll();
    });

    btnClear.addEventListener('click', ()=>{ ['p-name','p-category-manual','p-sku','p-price','p-stock','p-desc','img1','img2','img3'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; }); createMsg.textContent=''; });

    // create local category
    btnAddCategory.addEventListener('click', async ()=>{
      const name = (newCategoryNameInput.value||'').trim();
      if(!name) return toast('Category name required');
      const local = loadLocalCategories(); if(!local.includes(name)) local.push(name); saveLocalCategories(local);
      newCategoryNameInput.value='';
      await reloadAll();
      toast('Category created locally');
    });

    btnCreateLocalCat.addEventListener('click', async ()=>{
      const name = (categoryManual.value||'').trim();
      if(!name) return toast('Enter a category name first');
      const local = loadLocalCategories(); if(!local.includes(name)) local.push(name); saveLocalCategories(local);
      categoryManual.value='';
      await reloadAll();
      toast('Category added locally');
    });

    // reload all: refresh cached products then render with current search
    async function reloadAll(){
      try {
        await fetchAllProducts();
        await renderCategoriesView(4, currentSearchQuery);
      } catch(e){
        toast('Reload error: '+(e.message||e));
      }
    }

    // initial loadAll wrapper
    async function loadAll(){ await reloadAll(); }

    btnRefresh.addEventListener('click', ()=> loadAll());

    // CSV placeholders
    document.getElementById('btn-export').addEventListener('click', ()=> toast('CSV export placeholder'));
    document.getElementById('btn-import').addEventListener('click', ()=> toast('CSV import placeholder'));

    // ---------------- SEARCH wiring ----------------
    // debounce search for live typing
    const doSearchDebounced = debounce(async (q)=>{
      currentSearchQuery = q || '';
      await renderCategoriesView(4, currentSearchQuery);
    }, 220);

    adminSearch.addEventListener('input', (e)=>{
      const q = e.target.value || '';
      doSearchDebounced(q);
    });

    // Enter triggers immediate search
    adminSearch.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){
        e.preventDefault();
        const q = adminSearch.value || '';
        currentSearchQuery = q;
        renderCategoriesView(4, currentSearchQuery);
      }
    });

    adminSearchClear.addEventListener('click', async ()=>{
      adminSearch.value = '';
      currentSearchQuery = '';
      searchCount.textContent = '';
      await renderCategoriesView(4, '');
    });

    // ensure search state preserved after edits/creates/deletes (reloadAll already uses currentSearchQuery)
  </script>
</body>
</html>
